var fe={plain:"color: black; font-weight: normal",blue:"color: blue; font-weight: bold",brown:"color: brown; font-weight: bold",green:"color: green; font-weight: bold"},{plain:Jt}=fe,_e=(n,e=Jt,t=Jt)=>({log:(s,r="")=>console.log(`[${Date.now()}]%c[${n}] %c${s}`,e,t,r),warn:s=>console.warn(`[${n}] ${s}`)});var Qt=_e("WebsocketConnection",fe.brown),Zt={},it=Symbol("setWebsocket"),Te=Symbol("connectionCallback");async function lt(n,e){return at(n,e)}async function ut(n){at(n.url,n[Te],n)}async function at(n,e,t){let s=Zt[n]||(Zt[n]={attemptsRemaining:5,status:"disconnected"});try{e({type:"connection-status",status:"connecting"});let r=typeof t!="undefined",o=await Kn(n);console.log(`%c\u26A1 %c${n}`,"font-size: 24px;color: green;font-weight: bold;","color:green; font-size: 14px;"),t!==void 0&&t[it](o);let i=t??new ss(o,n,e),l=r?"reconnected":"connected";return e({type:"connection-status",status:l}),i.status=l,i}catch{let o=--s.attemptsRemaining>0;if(e({type:"connection-status",status:"disconnected",reason:"failed to connect",retry:o}),o)return qn(n,e,t,1e4)}}var qn=(n,e,t,s)=>new Promise(r=>{setTimeout(()=>{r(at(n,e,t))},s)}),Kn=n=>new Promise((e,t)=>{let s=new WebSocket("ws://"+n);s.onopen=()=>e(s),s.onerror=r=>t(r)}),es=()=>{Qt.log("Connection cannot be closed, socket not yet opened")},ts=n=>{Qt.log(`Message cannot be sent, socket closed: ${n.body.type}`)},ss=class{constructor(e,t,s){this.close=es;this.requiresLogin=!0;this.send=ts;this.status="ready";this.url=t,this[Te]=s,this[it](e)}reconnect(){ut(this)}[(Te,it)](e){let t=this[Te];e.onmessage=o=>{try{let i=JSON.parse(o.data);t(i)}catch{console.error("Error parsing JSON response from server",{data:o.data})}},e.onerror=()=>{console.log(`%c\u26A1 %c${this.url}`,"font-size: 24px;color: red;font-weight: bold;","color:red; font-size: 14px;"),t({type:"connection-status",status:"disconnected",reason:"error"}),this.status!=="closed"&&(ut(this),this.send=r)},e.onclose=()=>{console.log(`%c\u26A1 %c${this.url}`,"font-size: 24px;color: orange;font-weight: bold;","color:orange; font-size: 14px;"),t({type:"connection-status",status:"disconnected",reason:"close"}),this.status!=="closed"&&(ut(this),this.send=r)};let s=o=>{e.send(JSON.stringify(o))},r=o=>{console.log(`queuing message ${JSON.stringify(o)} until websocket reconnected`)};this.send=s,this.close=()=>{console.log("[Connection] close websocket"),this.status="closed",e.close(),this.close=es,this.send=ts}}};function ns(n){let e=Array(n);for(let t=0;t<n;t++)e[t]=t;return e}function rs(n,e,t=[],s=[]){for(let r=0,o=n.length;r<o;r++)(e(n[r],r)?t:s).push(n[r]);return[t,s]}var Hn=new Set(["=",">",">=","<","<=","starts","ends"]),ve=n=>Array.isArray(n.filters),ct=n=>Hn.has(n.op);var pt=n=>n.op==="in",Q=n=>n.op==="in",he=n=>n.op==="and",os=n=>n.op==="or";var L="and",Pe="=",Oe=">",Ue="<",ie="or",Z="starts";var z="in",ft=[{name:"name",flex:1},{name:"count",width:40,type:"number"},{name:"totalCount",width:40,type:"number"}],ht=[{name:"bin"},{name:"count"},{name:"bin-lo"},{name:"bin-hi"}];var Xn={combineWith:"and"};function is(n,e,{combineWith:t=L}=Xn){if(gt(e))ve(e)||(n=us(n,{name:e.column}));else if(zn(e)&&!ve(e))return us(n,{name:e.column});if(n){if(!e)return n}else return e;if(n.op===L&&e.op===L)return{op:L,filters:Jn(n.filters,e.filters)};if(n.op===L){let s=$n(n.filters,e);return s.length>1?{op:L,filters:s}:s[0]}else return e.op===L?{op:L,filters:e.filters.concat(n)}:ge(n,e,!0)?e:as(n,e)?Yn(n,e):{op:t,filters:[n,e]}}function gt(n){return n?Q(n)&&n.values.length===0?!0:he(n)&&n.filters.some(e=>gt(e)):!1}function zn(n){if(n){if(n.op===Z&&n.value==="")return!0}else return!1;return n.op===Z&&n.value===""}function $n(n,e){return n.concat(e)}function Yn(n,e){let{op:t}=n,{op:s}=e;return gt(e)?e:Q(n)&&Q(e)?{...n,values:n.values.concat(e.values.filter(r=>!n.values.includes(r)))}:n.op===Z&&e.op===Z?{op:ie,filters:[n,e]}:e}function Jn(n,e){function t({op:o},{op:i}){return o===i||o[0]===i[0]}let s=(o,i)=>o.column===i.column&&t(o,i),r=o=>e.some(i=>s(o,i))===!1;return n.filter(r).concat(e)}function ls(n,e){if(n){if(n.column===e)return[n,null];if(n.op!==L)return[null,n];{let[[t=null],s]=rs(n.filters,r=>r.column===e);return s.length===1?[t,s[0]]:[t,{op:L,filters:s}]}}else return[null,null]}var dt=(n,e)=>ve(n)?{op:n.op,filters:n.filters.map(t=>dt(t,e))}:{...n,column:e};function mt(n,e){if(!n)return null;let{op:t,column:s}=n;switch(t){case L:case ie:return Qn(t,n.filters,e);default:return s===e?n:null}}function Qn(n,e,t){let s=[];return e.forEach(r=>{let o=mt(r,t);o!==null&&s.push(o)}),s.length===1?s[0]:{op:n,filters:s}}function us(n,e){let t=e.name;if(n){if(n.column===t)return null;if(he(n)||os(n)){let{op:s}=n,o=n.filters.filter(i=>i.column!==t);switch(o.length){case 0:return null;case 1:return o[0];default:return{op:s,filters:o}}}else return n}else return null}var as=(n,e)=>n.column===e.column;function ge(n,e,t=!1){return n&&e&&as(n,e)?t?n.op===e.op&&(ct(n)&&ct(e)&&n.value===e.value||pt(n)&&pt(e)&&Zn(n.values,e.values)):!0:!1}function Zn(n,e){if(n===e)return!0;if(n.length===e.length){let t=n.slice().sort(),s=e.slice().sort();return t.join("|")===s.join("|")}return!1}function Ae(n,e){return n<e?-1:n>e?1:n>=e?0:NaN}function wt(n){let e=n,t=n;n.length===1&&(e=(i,l)=>n(i)-l,t=er(n));function s(i,l,u,a){for(u==null&&(u=0),a==null&&(a=i.length);u<a;){let c=u+a>>>1;t(i[c],l)<0?u=c+1:a=c}return u}function r(i,l,u,a){for(u==null&&(u=0),a==null&&(a=i.length);u<a;){let c=u+a>>>1;t(i[c],l)>0?a=c:u=c+1}return u}function o(i,l,u,a){u==null&&(u=0),a==null&&(a=i.length);let c=s(i,l,u,a-1);return c>u&&e(i[c-1],l)>-e(i[c],l)?c-1:c}return{left:s,center:o,right:r}}function er(n){return(e,t)=>Ae(n(e),t)}function cs(n){return n===null?NaN:+n}var ps=wt(Ae),tr=ps.right,Bo=ps.left,Wo=wt(cs).center,fs=tr;function Rt(n,e){let t=0;if(e===void 0)for(let s of n)s!=null&&(s=+s)>=s&&++t;else{let s=-1;for(let r of n)(r=e(r,++s,n))!=null&&(r=+r)>=r&&++t}return t}function Le(n,e){let t,s;if(e===void 0)for(let r of n)r!=null&&(t===void 0?r>=r&&(t=s=r):(t>r&&(t=r),s<r&&(s=r)));else{let r=-1;for(let o of n)(o=e(o,++r,n))!=null&&(t===void 0?o>=o&&(t=s=o):(t>o&&(t=o),s<o&&(s=o)))}return[t,s]}function hs(n){return n}var gs=Array.prototype,ds=gs.slice,Xo=gs.map;function de(n){return function(){return n}}var ms=Math.sqrt(50),ws=Math.sqrt(10),Rs=Math.sqrt(2);function ys(n,e,t){var s,r=-1,o,i,l;if(e=+e,n=+n,t=+t,n===e&&t>0)return[n];if((s=e<n)&&(o=n,n=e,e=o),(l=me(n,e,t))===0||!isFinite(l))return[];if(l>0){let u=Math.round(n/l),a=Math.round(e/l);for(u*l<n&&++u,a*l>e&&--a,i=new Array(o=a-u+1);++r<o;)i[r]=(u+r)*l}else{l=-l;let u=Math.round(n*l),a=Math.round(e*l);for(u/l<n&&++u,a/l>e&&--a,i=new Array(o=a-u+1);++r<o;)i[r]=(u+r)/l}return s&&i.reverse(),i}function me(n,e,t){var s=(e-n)/Math.max(0,t),r=Math.floor(Math.log(s)/Math.LN10),o=s/Math.pow(10,r);return r>=0?(o>=ms?10:o>=ws?5:o>=Rs?2:1)*Math.pow(10,r):-Math.pow(10,-r)/(o>=ms?10:o>=ws?5:o>=Rs?2:1)}function yt(n,e,t){let s;for(;;){let r=me(n,e,t);if(r===s||r===0||!isFinite(r))return[n,e];r>0?(n=Math.floor(n/r)*r,e=Math.ceil(e/r)*r):r<0&&(n=Math.ceil(n*r)/r,e=Math.floor(e*r)/r),s=r}}function Is(n){return Math.ceil(Math.log(Rt(n))/Math.LN2)+1}function Ne(){var n=hs,e=Le,t=Is;function s(r){Array.isArray(r)||(r=Array.from(r));var o,i=r.length,l,u=new Array(i);for(o=0;o<i;++o)u[o]=n(r[o],o,r);var a=e(u),c=a[0],p=a[1],f=t(u,c,p);if(!Array.isArray(f)){let d=p,w=+f;if(e===Le&&([c,p]=yt(c,p,w)),f=ys(c,p,w),f[f.length-1]>=p)if(d>=p&&e===Le){let R=me(c,p,w);isFinite(R)&&(R>0?p=(Math.floor(p/R)+1)*R:R<0&&(p=(Math.ceil(p*-R)+1)/-R))}else f.pop()}for(var h=f.length;f[0]<=c;)f.shift(),--h;for(;f[h-1]>p;)f.pop(),--h;var g=new Array(h+1),m;for(o=0;o<=h;++o)m=g[o]=[],m.x0=o>0?f[o-1]:c,m.x1=o<h?f[o]:p;for(o=0;o<i;++o)l=u[o],c<=l&&l<=p&&g[fs(f,l,0,h)].push(r[o]);return g}return s.value=function(r){return arguments.length?(n=typeof r=="function"?r:de(r),s):n},s.domain=function(r){return arguments.length?(e=typeof r=="function"?r:de([r[0],r[1]]),s):e},s.thresholds=function(r){return arguments.length?(t=typeof r=="function"?r:Array.isArray(r)?de(ds.call(r)):de(r),s):t},s}function bs(n){return Array.isArray(n)}function sr(n){return!Array.isArray(n)}var we=class{constructor(){this._events={}}addListener(e,t){this._events||(this._events={});let s=this._events[e];s?bs(s)?s.push(t):sr(s)&&(this._events[e]=[s,t]):this._events[e]=t}removeListener(e,t){if(!this._events||!this._events[e])return;let s=this._events[e],r=-1;if(s===t)delete this._events[e];else if(Array.isArray(s)){for(let o=length;o-- >0;)if(s[o]===t){r=o;break}if(r<0)return;s.length===1?(s.length=0,delete this._events[e]):s.splice(r,1)}}removeAllListeners(e){if(this._events)e===void 0?delete this._events:delete this._events[e];else return}emit(e,...t){if(this._events){let s=this._events[e];s&&It(s,e,t);let r=this._events["*"];r&&It(r,e,t)}}once(e,t){let s=(r,o)=>{this.removeListener(r,s),t(r,o)};this.on(e,s)}on(e,t){return this.addListener(e,t)}};function It(n,e,t){if(bs(n))n.slice().forEach(s=>It(s,e,t));else switch(t.length){case 0:n(e);break;case 1:n(e,t[0]);break;case 2:n(e,t[0],t[1]);break;default:n.call(null,e,...t)}}var nr={applyUpdates:!1,applyInserts:!1,interval:500};function Es(n){if(n){let e={IDX:0,KEY:1};for(let t=0;t<n.length;t++)e[n[t].name]=t+2;return e}else return null}var ee=class extends we{constructor(e){super();let{name:t,columns:s=null,primaryKey:r,dataPath:o,data:i,updates:l={}}=e;this.name=t,this.primaryKey=r,this.columns=s,this.keys={},this.index={},this.indices=[],this.rows=[],this.updateConfig={...nr,...l},this.inputColumnMap=void 0,this.columnMap=Es(s),this.columnCount=0,this.status=null,i?this.load(i):o&&this.fetchData(o),this.installDataGenerators(e)}update(e,...t){let s=[],r=this.rows[e];for(let o=0;o<t.length;o+=2){let i=t[o],l=t[o+1];s.push(i,r[i],l),r[i]=l}this.emit("rowUpdated",e,s)}bulkUpdate(e,t){let s=[];for(let r of e){let[o]=r,i=this.rows[o],l=[o];for(let u=1;u<r.length;u+=2){let a=r[u],c=r[u+1];l.push(a,i[a],c),i[a]=c}s.push(l)}this.emit("rowsUpdated",s,t)}insert(e){let t=this.columns?this.columns.map(o=>o.name):null,s=this.rows.length,r=this.rowFromData(s,e,t);this.rows.push(r),this.emit("rowInserted",s,r)}remove(e){if(this.keys[e]){let t=this.indices[e];delete this.keys[e],delete this.indices[e],this.rows.splice(t,1);for(let s in this.indices)this.indices[s]>t&&(this.indices[s]-=1);this.emit("rowRemoved",this.name,e)}}clear(){}toString(){let e=[`
`+this.name];return e.splice.apply(e,[1,0].concat(this.rows.map(function(t){return t.toString()}))),e.join(`
`)}async fetchData(e){fetch(e,{}).then(t=>t.json()).then(t=>{console.log(`Table.loadData: got ${t.length} rows`),this.load(t)}).catch(t=>{console.error(t)})}load(e){let t=this.columns?this.columns.map(r=>r.name):null,s=[];for(let r=0;r<e.length;r++){let o=this.rowFromData(r,e[r],t);s.push(o)}this.rows=s,this.columns===null&&(this.columns=or(this.inputColumnMap),this.columnMap=Es(this.columns)),this.status="ready",this.emit("ready"),this.updateConfig&&this.updateConfig.applyUpdates!==!1&&setTimeout(()=>{this.applyUpdates()},1e3),this.updateConfig&&this.updateConfig.applyInserts!==!1&&setTimeout(()=>{this.applyInserts()},1e4)}rowFromData(e,t,s){let{index:r,primaryKey:o=null,columnMap:i}=this;if(Array.isArray(t)){let l=t[i[this.primaryKey]-2];return r[l]=e,[e,l,...t]}else{let l=i||(this.columnMap={IDX:0,KEY:1}),u=s||Object.getOwnPropertyNames(t),a=[e],c;for(let p=0;p<u.length;p++){let f=u[p],h=t[f];(c=l[f])===void 0&&(c=l[f]=2+this.columnCount++),a[c]=h,(f===o||o===null&&p===0)&&(r[h]=e,a[i.KEY]=h)}return a}}applyInserts(){let e=this.rows.length,t=this.createRow(e);t?this.insert(t):console.log("createRow did not return a new row"),setTimeout(()=>this.applyInserts(),this.updateConfig.insertInterval|100)}applyUpdates(){let{rows:e,columnMap:t}=this,s=100;for(let r=0;r<s;r++){let o=rr(e.length-1),i=this.updateRow(o,e[o],t);i&&this.update(o,...i)}setTimeout(()=>this.applyUpdates(),this.updateConfig.interval)}createRow(e){return console.warn(`createRow ${e} must be implemented as a plugin`),null}updateRow(){return null}async installDataGenerators(){}};function rr(n){return Math.floor(Math.random()*Math.floor(n))}function or(n){return Object.getOwnPropertyNames(n).map(t=>({name:t,key:n[t]})).sort(ir).map(({name:t})=>({name:t}))}function ir(n,e){return n.key-e.key}var lr="checkbox",ur="single-row",ar="multiple-row",bt={Checkbox:lr,SingleRow:ur,MultipleRow:ar},{Checkbox:cr,SingleRow:pr,MultipleRow:fr}=bt,D=[];var Fe=class{constructor(e=fr){this.modelType=e}select({rows:e,lastTouchIdx:t},s,r,o){let i,l;return this.modelType===pr?([e,i,l]=this.handleRegularSelection(e,s),t=s):r?[e,i,l]=this.handleRangeSelection(e,t,s):o||this.modelType===cr?([e,i,l]=this.handleIncrementalSelection(e,s),t=s):([e,i,l]=this.handleRegularSelection(e,s),t=s),{focusedIdx:s,lastTouchIdx:t,rows:e,selected:i,deselected:l}}handleRegularSelection(e,t){if(e.indexOf(t)===-1){let r=[t];return[r,r,e]}else return e.length===1?[D,D,e]:[D,D,Cs(e,t)]}handleIncrementalSelection(e,t){let s=e.indexOf(t),r=e.length,o=[t];return s===-1?r===0?[o,o,D]:[dr(e,t),o,D]:r===1?[D,D,e]:[Cs(e,t),D,o]}handleRangeSelection(e,t,s){let r=e.indexOf(s),o=e.length;if(r===-1)if(o===0){let i=Ss(0,s);return[i,i,D]}else if(o===1){let i=Ss(e[0],s);return e=e[0]<s?i.slice(1):i.slice(0,-1),[i,e,D]}else{let i=hr(e,t,s);return[i,i.filter(l=>!e.includes(l)),D]}}};function hr(n,e,t){e>t&&([e,t]=[t,e]);let s=gr(n),r=new Et(e,t),o=!1,i=[];for(let l=0;l<s.length;l++){let u=s[l];if(u.overlaps(r)){if(!o){for(let a=r.start;a<=r.end;a++)i.push(a);o=!0}}else if(u.start<r.start)for(let a=u.start;a<=u.end;a++)i.push(a);else{for(let a=r.start;a<=r.end;a++)i.push(a);o=!0;for(let a=u.start;a<=u.end;a++)i.push(a)}}if(!o)for(let l=r.start;l<=r.end;l++)i.push(l);return i}function gr(n){let e=[],t;for(let s=0;s<n.length;s++)t&&t.touches(n[s])?t.extend(n[s]):e.push(t=new Et(n[s]));return e}var Et=class{constructor(e,t=e){this.start=e,this.end=t}extend(e){e>=this.start&&e>this.end&&(this.end=e)}touches(e){return this.end===e-1}overlaps(e){return!(this.end<e.start||this.start>e.end)}contains(e){return this.start<=e&&this.end>=e}toString(){return`[${this.start}:${this.end}]`}};function Ss(n,e){n>e&&([n,e]=[e,n]);let t=[];for(let s=n;s<=e;s++)t.push(s);return t}function Cs(n,e){let t=[];for(let s=0;s<n.length;s++)e!==n[s]&&t.push(n[s]);return t}function dr(n,e){let t=[];for(let s=0;s<n.length;s++)e!==null&&e<n[s]&&(t.push(e),e=null),t.push(n[s]);return e!==null&&t.push(e),t}var mr="asc";function N(n,e,t=0){return n.map(s=>{if(typeof s=="string")return[e[s]+t,"asc"];if(Array.isArray(s)){let[r,o]=s;return[e[r]+t,o||mr]}else throw Error("columnUtils.mapSortCriteria invalid input")})}function De(n){let e=[],t=b.count-2;for(let s=0;s<n.length;s+=3)e[s]=n[s]+t,e[s+1]=n[s+1],e[s+2]=n[s+2];return e}function xs(n,e){let t=e.length,{IDX:s,RENDER_IDX:r,DEPTH:o,COUNT:i,KEY:l,SELECTED:u,count:a}=b;return(c,p,f=[])=>(h,g)=>{let m=h[s],d=[];for(let w=0;w<t;w++){let R=n[e[w].name];d[a+w]=h[R]}return d[s]=c+g+p,d[r]=0,d[o]=0,d[i]=0,d[l]=h[n.KEY],d[u]=f.includes(m)?1:0,d}}var b={IDX:0,RENDER_IDX:1,IS_LEAF:2,IS_EXPANDED:3,DEPTH:4,COUNT:5,KEY:6,SELECTED:7,count:8,PARENT_IDX:"parent_idx",IDX_POINTER:"idx_pointer",FILTER_COUNT:"filter_count",NEXT_FILTER_IDX:"next_filter_idx"};var wr={Enter:"Enter",Delete:"Delete"},Rr={Home:"Home",End:"End",ArrowRight:"ArrowRight",ArrowLeft:"ArrowLeft",ArrowDown:"ArrowDown",ArrowUp:"ArrowUp",Tab:"Tab"},yr={F1:"F1",F2:"F2",F3:"F3",F4:"F4",F5:"F5",F6:"F6",F7:"F7",F8:"F8",F9:"F9",F10:"F10",F11:"F11",F12:"F12"},wi={...wr,...Rr,...yr};var A={ROW_DATA:"rowData",FILTER_DATA:"filterData",FILTER_BINS:"filterBins"},te="asc",Re="dsc";function se({from:n,to:e,lo:t=n,hi:s=e},r=0,o=Number.MAX_SAFE_INTEGER){if(r===0)return{from:t,to:Math.min(s,o)};if(t===0)return{from:t,to:Math.min(s+r,o)};{let i=s-t,l=Math.round(r/2),u=t-l<0,a=o-(s+l)<0;return u&&a?{from:0,to:o}:u?{from:0,to:i+r}:a?{from:Math.max(0,o-(i+r)),to:o}:{from:t-l,to:s+l}}}function ke({lo:n,hi:e,bufferSize:t=0}){return{lo:0,hi:e-n,bufferSize:t,reset:!0}}var le=class{constructor(e,t){this.from=e,this.to=t}isWithin(e){return e>=this.from&&e<this.to}overlap(e,t){return e>=this.to||t<this.from?[0,0]:[Math.max(e,this.from),Math.min(t,this.to)]}copy(){return new le(this.from,this.to)}};function Ms(n,e,t){for(let s=0,r=n.length;s<r;s++)e[n[s][t]]=s;return e}function Vs(n){return n.length===0||Array.isArray(n[0])?n:n.map(e=>[e,null])}function _s(n,e,t,s){Ir(n,e,t,s)}function Ts(n,e,t,s){let r=N(t,s),o=r.length;(o===1?br:o===2?Er:o===3?Sr:Cr)(n,e,r)}function Ir(n,e,t,s){let r=n.length,o=N(t,s),[i]=o[1];for(let l=0;l<r;l++)n[l][2]=e[n[l][0]][i];n.sort((l,u)=>l[1]>u[1]?1:u[1]>l[1]?-1:l[2]>u[2]?1:u[2]>l[2]?-1:0)}function br(n,e,[[t,s]]){let r=n.length;for(let o=0;o<r;o++){let i=n[o][0];n[o][1]=e[i][t]}s===te?n.sort((o,i)=>o[1]>i[1]?1:i[1]>o[1]?-1:0):n.sort((o,i)=>o[1]>i[1]?-1:i[1]>o[1]?1:0)}function Er(n,e,t){let s=e.length,[r]=t[0],[o]=t[1];for(let i=0;i<s;i++)n[i][0]=i,n[i][1]=e[i][r],n[i][2]=e[i][o];n.sort((i,l)=>i[1]>l[1]?1:l[1]>i[1]?-1:i[2]>l[2]?1:l[2]>i[2]?-1:0)}function Sr(){}function Cr(){}function vs(n,e,t=n.length){if(n&&e&&n.length>0&&e.length===t){for(let s=0;s<t;s++){let[r,o=te]=n[s],[i,l=te]=e[s];if(r!==i||o===l)return!1}return!0}else return!1}function Ps(n,e,[t,s]){if(n===e)return 0;{let r=s===Re?e[t]:n[t],o=s===Re?n[t]:e[t];if(o===null||r>o)return 1;if(r==null||r<o)return-1}}function xr(n,e,[t,s]){if(n===e)return 0;{let r=s===Re?e[t]:n[t],o=s===Re?n[t]:e[t];if(o===null||r>o)return 1;if(r==null||r<o)return-1}}function $(n,e=xr){return function(t,s){for(let r=0,o=0,i=n.length;r<i;r++)if(o=e(t,s,n[r]))return o;return 0}}function ne(n,e,t,s="last-available"){function r(i){let l=n.length,u=a=>e(n[a],t)===0;if(s==="last-available")for(;i<l&&u(i);)i+=1;else if(s==="first-available")for(;i>0&&u(i-1);)i-=1;return i}function o(i,l){let u=i+Math.floor((l-i)/2),a=e(n[u],t);return i===u?r(a>=0?i:l):(a>=0?l=u:i=u,o(i,l))}return n.length===0?0:o(0,n.length)}var{IDX:ye,RENDER_IDX:Mr,IS_LEAF:Os,IS_EXPANDED:Vr,DEPTH:q,COUNT:Ge,KEY:Us,SELECTED:_r,PARENT_IDX:Be,IDX_POINTER:Ie,FILTER_COUNT:We,NEXT_FILTER_IDX:As,count:F}=b,Tr={startIdx:0,rootIdx:null,baseGroupby:[]},je="|";function Ls(n,e=null){if(e!==null)for(let t=0;t<e.length;t++){let[s,,r]=e[t];if(s===n||r===n)return t}return-1}function St(n,e,t,s,r){let o=Number.MAX_SAFE_INTEGER;for(let i=s;i<n.length;i++){let l=n[i],u=l[t];if(u<r)break;if(u===r){let a=l[e];typeof a=="number"&&a<o&&(o=a)}}return o===Number.MAX_SAFE_INTEGER?void 0:o}function H(n,e,t){return typeof n[e]=="number"?n[e]:n[t]}var Ct=class{constructor(e){this.levels=Array(e).fill(0).reduce((t,s,r)=>(t[r+1]={key:null,pos:null,pPos:null},t),{})}set(e,t,s){if(this.levels){let r=this.levels[Math.abs(e)];r&&r.key!==s&&(r.key!==null&&(r.pPos=r.pos),r.key=s,r.pos=t)}}hasParentPos(e){return this.levels[e+1]&&this.levels[e+1].pos!==null}parentPos(e){return this.levels[e+1].pos}hasPreviousPos(e){return this.levels[e]&&this.levels[e].pPos!==null}previousPos(e){return this.levels[e].pPos}},qe=class{constructor(e){this.idxAdjustment=0,this.maxLevel=e+1,this.levels=e>0?Array(e).fill(0).reduce((t,s,r)=>(t[r+2]={key:null,current:0,previous:0},t),{}):null}increment(e){if(this.idxAdjustment+=e,this.levels)for(let t=2;t<this.maxLevel+1;t++)this.levels[t].current+=e}previous(e){return this.levels&&this.levels[e]&&this.levels[e].previous||0}hasPrevious(e){return this.previous(e)>0}get(e){return this.levels===null?null:this.levels[e]}set(e,t){if(this.levels){let s=this.levels[e];s&&s.key!==t&&(s.key!==null&&(s.previous+=s.current,s.current=0),s.key=t)}}},vr=n=>!isNaN(parseInt(n,10)),Pr=(n,e)=>parseInt(n)-parseInt(e);function Or(n){let e=Object.keys(n);return e.every(vr)?e.sort(Pr):e.sort()}function Ns(n,e,t=0,s=null,r,o){let i=Or(n),l=s!==null,u=l?s.slice(r,o):null;for(let a=0;a<i.length;a++){let c=n[i[a]];if(Array.isArray(c))for(let p=0,f=c.length;p<f;p++){let h=c[p];e[t]=h,t+=1,l&&u.includes(h)&&(s[r]=h,r+=1)}else t=Ns(c,e,t)}return t}function be(n,e,t,s,r,o=Tr){let{startIdx:i=0,length:l=n.length,rootIdx:u=null,baseGroupby:a=[],groups:c=[],rowParents:p=null,filterLength:f,filterSet:h,filterFn:g}=o,{depth:m=1,groupIdx:d=-1,filterIdx:w}=o,R=Mt(t,s,r),M=Fr(e,n,r,i,l);Ns(M,e,i,h,w,f);let C=r.length,x=C+a.length,S=Array(C).fill(null),I=u,E=0;for(let y=i,_=i+l;y<_;y++){let V=e[y],U=n[V];for(let O=0;O<C;O++){let[K]=r[O],T=S[O],pe=U[K];if(T===null||T[F+K-2]!==pe){if(T!==null){for(let P=C-1;P>=O;P--){let v=S[P];Vt(v,c,e,n,R,x,E,g),h&&Math.abs(v[q])===1&&v[We]>0&&(v[As]=w,w+=v[We])}E=0}for(let P=O;P<C;P++){d+=1,I=P===0?u:S[P-1][ye];let v=m+P,X=v===x?y:d+1,J=S[P]=Nr(U,v,d,X,I,r,t,s,a);c.push(J)}break}}p&&(p[V]=d),E+=1}for(let y=C-1;y>=0;y--)if(S[y]!==null){let _=S[y];Vt(_,c,e,n,R,x,E,g),h&&Math.abs(_[q])===1&&_[We]>0&&(_[As]=w)}return c}function Ke(n,e){return n.length>e.length&&e.every((t,s)=>t[0]===n[s][0])}function Fs(n,e){return e.length>n.length&&n[0][0]===e[0][0]&&n.every(([t])=>e.find(([s])=>s===t))}function Ds(n,e){let[t]=xt(n,e);return t!==null}function ks(n,e){return e.reduce((t,[s],r)=>(n.some(o=>o[0]===s)||t.push(r+1),t),[])}function xt(n,e){let t=[null],s=n&&n.length,r=e&&e.length;if(s&&r&&s===r)for(let o=0;o<s;o++){if(n[o][0]!==e[o][0])return t;n[o][1]!==e[o][1]&&(t[0]=o,t[1]=s-o)}return t}function Ur([n],[e]){return n>e?1:e>n?-1:0}var Ar={};function He(n,e=null,t="",s=0){let r=[];return Object.entries(n).forEach(([i,l])=>{if(l&&(e===null||!e[i])){if(r.push([t+i,s,!0]),l!==null&&typeof l=="object"&&Object.keys(l).length>0){let u=He(l,Ar,t+i+"/",s+1);u.length&&r.push(...u)}}else if(l){let u=He(l,e[i],t+i+"/",s+1);u.length&&r.push(...u)}}),e!==null&&typeof e=="object"&&Object.entries(e).forEach(([i,l])=>{l&&!n[i]&&r.push([t+i,s,!1])}),r.sort(Ur)}function Gs(n,e){do{if(e[q]<0)return!1;e=n[e[Be]]}while(e);return!0}function Bs(n,e,t=1){for(let s=0;s<n.length;s++)if(n[s][ye]>=e){n[s][ye]+=t,Math.abs(n[s][q])>1&&(n[s][Ie]+=t);let r=n[s][Be];r!==null&&r>=e&&(n[s][Be]+=t)}}function Ws(n,e,t=1){for(let s=0;s<n.length;s++)Math.abs(n[s][q])===1&&n[s][Ie]>=e&&(n[s][Ie]+=t)}function js(n,e,t){let s=[];e:for(let r=0;r<e.length;r++){let o=$(e.slice(0,r+1),Ps),i=ne(n,o,t,"first-available"),l=n[i];if(l===void 0)break;for(let u=0;u<e.length;u++){let a=e[u][0],c=l[a];if(u>r){if(c!==null)break e}else if(c!==t[a])break e}s.push(i)}return s}var qs=(n,e,t)=>{let s=e.slice();return s[t.IDX]=0,s[t.DEPTH]=0,s[t.COUNT]=0,s[t.KEY]=Lr(n,e),s[t.SELECTED]=0,s};function Lr(n,e){let t=([s])=>e[s];return n.map(t).join("/")}function Nr(n,e,t,s,r,o,i,l,u=[]){let a=Array(F+i.length),c=e-1,p;for(let w=0;w<i.length;w++){let R=i[w],M=l[R.name],C=F+w;R.aggregate?a[C]=0:(p=Ls(M,o))!==-1&&p<=c?a[C]=n[M]:a[C]=null}for(let w=0;w<u.length;w++){let[R]=u[w];a[F+R-2]=n[R]}let f=([w])=>n[w],h=w=>w.map(f).join(je),g="$root"+je,m=u.length>0?g+h(u)+je:g,d=h(o.slice(0,c+1));return a[ye]=t,a[Mr]=0,a[Os]=!1,a[Vr]=!1,a[q]=e,a[Ge]=0,a[Us]=m+d,a[_r]=0,a[Be]=r,a[Ie]=s,a}function Fr(n,e,t,s=0,r=n.length){let o={},i=t.length,l=i-1;for(let u=s,a=s+r;u<a;u++){let c=n[u],p=e[c],f=o,h,g;for(let m=0;m<i;m++){let[d]=t[m];g=p[d],h=f[g],h&&m===l?h.push(c):h?f=h:!h&&m<l?f=f[g]={}:h||(f[g]=[c])}}return o}function Ks(n,e){let t=n.length,s=e===t,r=e-1,o=[],i=[];return n.forEach((l,u)=>{u<r?o.push(l):u>r&&i.push(l)}),[s,o,i]}function Mt(n,e,t){return n.reduce((s,r)=>{if(r.aggregate&&Ls(r.name,t)===-1){let o=e[r.name];s.push([o,r.aggregate])}return s},[])}function Hs(n,e,t,s,r,o,i){let u=n[e][q],a=Math.abs(u),c=0,p=e;for(;p<n.length-1&&Math.abs(n[p+1][q])<a;)p+=1,c+=1;for(let f=e+c;f>=e;f--){for(let h=0;h<o.length;h++){let[g]=o[h],m=g+F-2;n[f][m]=0}Vt(n[f],n,t,s,o,i,n[f][Ge])}}function Vt(n,e,t,s,r,o,i,l=null){let u=n[q],a=0,c=l===null?void 0:0;if(u===o){let p=n[Ie],f=p+i;a=i;for(let h=p;h<f;h++){let g=s[t[h]],m=l===null||l(g);if(l&&m&&(c+=1),l===null||m)for(let d=0;d<r.length;d++){let[w]=r[d];n[F+w-2]+=g[w]}}}else{let p=e.indexOf(n)+1;for(let f=p;f<e.length;f++){let h=e[f],g=h[q],m=h[Ge],d=Math.abs(g);if(d>=u)break;if(d===u-1){for(let w=0;w<r.length;w++){let[R,M]=r[w];M==="avg"?n[F+R-2]+=h[F+R-2]*m:n[F+R-2]+=h[F+R-2]}a+=m}}}for(let p=0;p<r.length;p++){let[f,h]=r[p];h==="avg"&&(n[F+f-2]=n[F+f-2]/a)}n[Ge]=a,n[We]=c}function ue(n,[e,t,...s]){let r=Array(F).fill(0).concat(s);return r[ye]=e,r[Us]=`${n}${je}${t}`,r[Os]=!0,r}var Xs=(n,e)=>n.column===e.column?0:n.column&&e.column&&n.column<e.column?-1:1;function Xe(n=null,e=null){if(e===null)return!1;if(n===null)return!0;if(n.column&&n.column===e.column){if(n.op===e.op)switch(n.op){case z:return e.values.length<n.values.length&&zs(n.values,e.values);case Z:return e.value.length>n.value.length&&e.value.indexOf(n.value)===0;default:}}else{if(n.column&&e.column)return!1;if(he(e)&&Dr(n,e))return!0}return!1}function Dr(n,e){if(n.column){let t=e.filters.find(s=>s.column===n.column);return ge(t,n,!0)}else if(n.filters.length===e.filters.length){let t=n.filters.sort(Xs),s=e.filters.slice().sort(Xs);for(let r=0;r<t.length;r++)if(!ge(t[r],s[r],!0)&&!kr(t[r],s[r]))return!1;return!0}else if(e.filters.length>n.filters.length)return n.filters.every(t=>{let s=e.filters.find(r=>r.column===t.column);return ge(t,s,!0)})}function kr(n,e){return Q(n)&&Q(e)?e.values.length<n.values.length&&zs(n.values,e.values):!1}function zs(n,e){for(let t=0,s=e.length;t<s;t++)if(n.indexOf(e[t])===-1)return!1;return!0}function B(n,e){switch(e.op){case z:return Kr(n,e);case Pe:return Hr(n,e);case Oe:return jr(n,e);case Ue:return qr(n,e);case Z:return Wr(n,e);case L:return Gr(n,e);case ie:return Br(n,e);default:return()=>!0}}function Gr(n,e){let t=e.filters.map(s=>B(n,s));return s=>t.every(r=>r(s))}function Br(n,e){let t=e.filters.map(s=>B(n,s));return s=>t.some(r=>r(s))}function Wr(n,e,t=!1){let s=e.value.toLowerCase();return t?r=>r[n[e.column]].toLowerCase().indexOf(s)!==0:r=>r[n[e.column]].toLowerCase().indexOf(s)===0}function jr(n,e){return t=>t[n[e.column]]>e.value}function qr(n,e){return t=>t[n[e.column]]<e.value}function Kr(n,e){return t=>e.values.findIndex(s=>s==t[n[e.column]])!==-1}function Hr(n,e){return t=>t[n[e.column]]===e.value}var Y={lo:0,hi:0};function ze(n,e){let{lo:t,hi:s}=n,{lo:r,hi:o}=e;return r>=t&&o<=s?{from:o,to:o}:r>=s||o<t?{from:r,to:o}:r===t&&o===s?{from:s,to:s}:{from:r<t?r:s,to:o>s?o:t}}var $s=0,Ee=2,Se=4,$e=8,Ye=16,Je=32,_t=64,Ys=128,W={SAME:$s,FWD:Ee,BWD:Se,CONTIGUOUS:$e,OVERLAP:Ye,REDUCE:Je,EXPAND:_t,NULL:Ys};W.GAP=~($e|Ye|Je);function Js(n,e){return e.lo===0&&e.hi===0?Ys:n.lo===e.lo&&n.hi===e.hi?$s:e.hi>n.hi?e.lo>n.hi?Ee:e.lo===n.hi?Ee+$e:e.lo>=n.lo?Ee+Ye:_t:e.lo<n.lo?e.hi<n.lo?Se:e.hi===n.lo?Se+$e:e.hi>n.lo?Se+Ye:_t:e.lo>n.lo?Je+Ee:Je+Se}var Xr=1,zr={filter:null},Ce=class{constructor(e,t=0,s=Y){this.table=e,this.offset=t,this.baseOffset=t,this.range=s,this.currentFilter=null,this.filterSet=null,this.sortSet=void 0,this.data=e.rows,this.type=void 0,this.index=void 0,this.selectedRowsIDX=[]}get size(){return console.error("size must be implemented by concrete Rowset"),0}slice(){throw new Error("slice must be implemented by concrete Rowset")}get filteredData(){if(this.filterSet)return this.filterSet;{let{IDX:e}=b;return this.data.map(t=>t[e])}}get stats(){let{totalRowCount:e,filteredRowCount:t,selectedRowsIDX:s}=this,r=s.length;return{totalRowCount:e,totalSelected:r,filteredRowCount:t,filteredSelected:0}}get totalRowCount(){return this.data.length}get filteredRowCount(){return this.filterSet===null?this.data.length:this.filterSet.length}get selectedRowCount(){return this.selectedRowsIDX.length}setRange(e=this.range,t=!0,s=!1){let{from:r,to:o}=t?ze(this.range,e):se(e),i=this.slice(r,o);this.range=e;let l=this.size;return{dataType:this.type,rows:i,range:e,size:l,offset:this.offset,stats:s?this.stats:void 0}}currentRange(){let{lo:e,hi:t}=this.range,s=this.slice(e,t);return{dataType:this.type,rows:s,range:this.range,size:this.size,offset:this.offset,stats:void 0}}select(e){let{range:{lo:t,hi:s},filterSet:r,sortSet:o}=this;console.log({lo:t,hi:s,sortSet:o,filterSet:r});let i=l=>o[l][0];return this.selectedRowsIDX=e.map(i),this.currentRange()}selectAll(){let{data:e,selected:t,selectedRowsIDX:s,range:{lo:r,hi:o},filterSet:i,offset:l}=this,{SELECTED:u}=b,a=[...this.selected.rows];if(i)for(let f=0;f<i.length;f++){let h=i[f];s.includes(h)||(t.rows.push(f),s.push(h))}else this.selected={rows:ns(e.length),focusedIdx:-1,lastTouchIdx:-1},this.selectedRowsIDX=[...this.selected.rows];let c=[],p=Math.min(o,(i||e).length);for(let f=r;f<p;f++)this.selected.rows.includes(f)&&!a.includes(f)&&c.push([f+l,u,1]);return c}selectNone(){let{range:{lo:e,hi:t},filterSet:s,offset:r}=this,{SELECTED:o}=b,i=this.selectedRowsIDX;s?(this.selected={rows:[],focusedIdx:-1,lastTouchIdx:-1},this.selectedRowsIDX=this.selectedRowsIDX.filter(u=>!s.includes(u))):(this.selected={rows:[],focusedIdx:-1,lastTouchIdx:-1},this.selectedRowsIDX=[]);let l=[];for(let u=e;u<t;u++){let a=s?s[u]:u;i.includes(a)&&l.push([u+r,o,0])}return l}selectNavigationSet(e){let{COUNT:t,IDX_POINTER:s,FILTER_COUNT:r,NEXT_FILTER_IDX:o}=b;return e?[this.filterSet,o,r]:[this.sortSet,s,t]}getBinnedValuesForColumn(e){let t=this.table.columnMap[e.name],{data:s,filteredData:r}=this,o=r.map(a=>s[a][t]),i=Ne().thresholds(20)(o).map((a,c)=>[c+1,a.length,a.x0,a.x1]),l=new ee({data:i,primaryKey:"bin",columns:ht});return new vt(l,ht,e.name)}getDistinctValuesForColumn(e){let{data:t,currentFilter:s}=this,r=this.table.columnMap[e.name],o={},i=[],l=t.length,[,u]=ls(s,e),a=0;if(u===null){let p;for(let f=0;f<l;f++){let h=t[f][r];(p=o[h])?p[2]=++p[1]:(p=[h,1,1],o[h]=p,i.push(p))}a=l}else{let p=B(this.table.columnMap,u),f;for(let h=0;h<l;h++){let g=t[h],m=g[r],d=p(g)?1:0;(f=o[m])?(f[1]+=d,f[2]++):(f=[m,d,1],o[m]=f,i.push(f)),a+=d}}let c=new ee({data:i,primaryKey:"name",columns:ft});return new Tt(c,ft,e.name,a,l)}},j=class extends Ce{static fromGroupRowSet({table:e,columns:t,offset:s,currentFilter:r}){return new j(e,t,s,{filter:r})}constructor(e,t,s=0,{filter:r=null}=zr){super(e,s);this.type="rowData",this.project=xs(e.columnMap,t),this.sortCols=null,this.sortReverse=!1,this.sortSet=this.buildSortSet(),this.filterSet=null,this.sortRequired=!1,r&&(this.currentFilter=r,this.filter(r))}buildSortSet(){let e=this.data.length,t=Array(e);for(let s=0;s<e;s++)t[s]=[s,null,null];return t}slice(e,t){let{data:s,selectedRowsIDX:r,filterSet:o,offset:i,sortCols:l,sortSet:u,sortReverse:a}=this;if(o){let c=typeof o[0]=="number"?f=>s[f]:([f])=>s[f],p=[];for(let f=e,h=o.length;f<h&&f<t;f++){let g=c(a?o[h-f-1]:o[f]);p.push(g)}return p.map(this.project(e,i,r))}else if(l){let c=[];for(let p=e,f=s.length;p<f&&p<t;p++){let h=a?u[f-p-1][0]:u[p][0],g=s[h];c.push(g)}return c.map(this.project(e,i,r))}else return this.data.slice(e,t).map(this.project(e,i,r))}get size(){return this.filterSet===null?this.data.length:this.filterSet.length}get first(){return this.data[0]}get last(){return this.data[this.data.length-1]}get rawData(){return this.data}setSubscribedColumns(e){console.log(`Rowset setSubscribedColumns ${e.join(",")}`)}setStatus(e){this.status=e}addRows(e){Ms(e,this.index,b.IDX),this.data=this.data.concat(e)}sort(e){let t=this.currentFilter===null?this.sortSet:this.filterSet=Vs(this.filterSet);this.sortRequired=this.currentFilter!==null,vs(this.sortCols,e,Xr)?this.sortReverse=!this.sortReverse:this.sortCols!==null&&Ke(e,this.sortCols)?(this.sortReverse=!1,_s(t,this.data,e,this.table.columnMap)):(this.sortReverse=!1,Ts(t,this.data,e,this.table.columnMap)),this.sortCols=e}clearFilter(){this.currentFilter=null,this.filterSet=null,this.sortRequired&&this.sort(this.sortCols)}filter(e){let t=Xe(this.currentFilter,e),s=e&&B(this.table.columnMap,e),{data:r}=this,[o]=this.selectNavigationSet(t&&this.filterSet),i=[];for(let l=0;l<o.length;l++){let u=o===this.filterSet?o[l]:o[l][0],a=r[u];s(a)&&i.push(u)}if(this.selectedRowsIDX.length){let{selectedRowsIDX:l,selected:u}=this;u.rows.length=0;for(let a=0;a<i.length;a++){let c=i[a];l.includes(c)&&u.rows.push(a)}}return this.filterSet=i,this.currentFilter=e,!t&&this.sortRequired&&this.sort(this.sortCols),i.length}update(e,t){if(this.currentFilter===null&&this.sortCols===null){if(e>=this.range.lo&&e<this.range.hi)return[e+this.offset,...De(t)]}else if(this.currentFilter===null){let{sortSet:s}=this;for(let r=this.range.lo;r<this.range.hi;r++){let[o]=s[r];if(o===e)return[r+this.offset,...De(t)]}}else{let{filterSet:s}=this;for(let r=this.range.lo;r<this.range.hi;r++)if((Array.isArray(s[r])?s[r][0]:s[r])===e)return[r+this.offset,...De(t)]}}insert(e,t){if(this.sortCols===null&&this.currentFilter===null)return this.sortSet.push([e,null,null]),e>=this.range.hi?{size:this.size}:{size:this.size,replace:!0};if(this.currentFilter===null){let s=N(this.sortCols,this.table.columnMap),[[r]]=s,o=[e,t[r]],i=$([[1,"asc"]]),l=ne(this.sortSet,i,o,"last-available");this.sortSet.splice(l,0,o);let u=this.sortReverse?this.size-l:l;return u>=this.range.hi?{size:this.size}:u>=this.range.lo?{size:this.size,replace:!0}:{size:this.size,offset:this.offset-1}}else if(this.sortCols===null)if(B(this.table.columnMap,this.currentFilter)(t)){let r=this.filterSet.length;return this.filterSet.push(e),r>=this.range.hi?{size:this.size}:r>=this.range.lo?{size:this.size,replace:!0}:{size:this.size,offset:this.offset-1}}else return{};else if(B(this.table.columnMap,this.currentFilter)(t)){let r=N(this.sortCols,this.table.columnMap),[[o,i]]=r,l=[e,t[o]],u=$([[1,i]]),a=ne(this.filterSet,u,l,"last-available");return this.filterSet.splice(a,0,l),a>=this.range.hi?{size:this.size}:a>=this.range.lo?{size:this.size,replace:!0}:{size:this.size,offset:this.offset-1}}else return{}}},Tt=class extends j{constructor(e,t,s,r,o){super(e,t);this.type=A.FILTER_DATA,this.columnName=s,this._searchText=null,this.dataRowFilter=null,this.dataCounts={dataRowTotal:o,dataRowAllFilters:r,dataRowCurrentFilter:0,filterRowTotal:this.data.length,filterRowSelected:this.data.length,filterRowHidden:0},this.sort([["name","asc"]])}createSelectionModel(){return new Fe(bt.Checkbox)}clearRange(){this.range={lo:0,hi:0}}get values(){let e=this.table.columnMap.name;return this.filterSet.map(t=>this.data[t][e])}getSelectedValue(e){let{data:t,sortSet:s,filterSet:r}=this;if(r){let o=r[e],i=typeof o=="number"?o:o[0];return t[i][0]}else return s[e][1]}setSelectedFromFilter(e){let t=mt(e,this.columnName),s=this.table.columnMap,{data:r,filterSet:o,sortSet:i}=this;if(this.dataRowFilter=e,t){let l=B(s,dt(t,"name")),u=[],a=[];if(o)for(let c=0;c<o.length;c++){let p=o[c];l(r[p])&&(u.push(c),a.push(p))}else for(let c=0;c<r.length;c++){let p=i[c][0];l(r[p])&&(u.push(c),a.push(p))}this.selected={rows:u,focusedIdx:-1,lastTouchIdx:-1},this.selectedRowsIDX=a}else this.selectAll();return this.currentRange()}},vt=class extends j{constructor(e,t,s){super(e,t);this.type=A.FILTER_BINS,this.columnName=s}setSelectedFromFilter(e){console.log("need to apply filter to selected BinRowset",e)}setRange(){let e=this.size;return{dataType:this.type,rows:this.data,range:null,size:e,offset:0,stats:void 0}}};var k=4,xe=[null,null,null],{IS_EXPANDED:Qe,DEPTH:Ze,KEY:Pt,PARENT_IDX:Qs}=b,re=0,Ot=1;function Ut(n,e,t,s,r,o){let i=0,l=null,u=null,a=re,c=Y,p=[0,null,null],f=[],h=[null,null,null],g=e.length;return{get direction(){return a},get rangePositions(){return f},setRange:x,currentRange:C,getRangeIndexOfGroup:d,getRangeIndexOfRow:w,setNavSet:M,setGroupCount:m,refresh:C,clear:R};function m(I){g=I}function d(I){let E=f;for(let y=0;y<E.length;y+=k)if(E[y+1]===I)return E[y+2]===null?y/k:-1;return-1}function w(I){let E=f;for(let y=0;y<E.length;y+=k)if(E[y+3]===I)return y/k;return-1}function R(){i=0,l=null,u=null,a=re,c=Y,p=[0,null,null],f=[],h=[null,null,null]}function M([I,E,y]){t=I,r=E,o=y}function C(){let I=[[],null],[E]=I,{IDX:y}=b;[i,l,u]=p,i===0&&l===null&&u===null&&(i=-1),f.length=0;let _=i,V,U=c.lo;do if(a=re,[V,l,u]=oe(n,g,s,l,u,t,r,o),V){E.push(V),i+=1;let O=u===null?null:V[y];f.push(i,l,u,O),U+=1}while(V&&U<c.hi);if(V){a=re;let[O,K]=[l,u];[V,l,u]=oe(n,g,s,l,u,t,r,o),i+=1,h=[V?i:null,l,u],[l,u]=[O,K]}else h=[null,null,null];return I[1]=_+1,I}function x(I,E=!0){let y=Js(c,I),{from:_,to:V}=E?ze(c,I):se(I),{IDX:U}=b,O=[[],null],[K]=O;if(y===W.NULL)return p=[0,null,null],h=[null,null,null],f.length=0,O;if(I.lo===c.lo&&E===!1)[i,l,u]=p,f.length=0;else{a===re&&y&W.BWD?[i,l,u]=f:a===Ot&&y&W.FWD&&([i,l,u]=f.slice(-k),i+=1),y===W.FWD?(S(I.lo-c.hi,oe),f.length=0):y===W.BWD&&(S(c.lo-I.hi,Lt),f.length=0);let P=I.lo-c.lo,v=c.hi-I.hi,X=c.hi-c.lo-f.length/k;if(P>0){let J=f.splice(0,P*k);J.length&&(p=J.slice(-k),E===!1&&([i,l,u]=p))}if(v>0&&v>X){let J=v-X,Yt=f.splice(-J*k,J*k);Yt.length&&(h=Yt.slice(0,k))}}let T,pe=null;if((y&W.REDUCE)==0)if(y&W.FWD||y===W.SAME){let P=_;pe=i;do if(a=re,[T,l,u]=oe(n,g,s,l,u,t,r,o),T){K.push(T);let v=u===null?null:T[U];f.push(i,l,u,v),P+=1,i+=1}while(T&&P<V);if(T){a=re;let[v,X]=[l,u];[T,l,u]=oe(n,g,s,l,u,t,r,o),h=[T?i:null,l,u],[l,u]=[v,X]}else h=[null,null,null]}else{let P=V-1;do if(a=Ot,[T,l,u]=Lt(n,g,s,l,u,t,r,o),T){i-=1,K.unshift(T);let v=u===null?null:T[U];f.unshift(i,l,u,v),P-=1}while(T&&P>=_);if(pe=i,T){let[v,X]=[l,u];a=Ot,[T,l,u]=Lt(n,g,s,l,u,t,r,o),p=[T?i-1:0,l,u],[l,u]=[v,X]}else p=[0,null,null]}else y&W.FWD?(console.log("adjust thye idx"),[i,l,u]=f.slice(-k),i+=1):[i,l,u]=f;return c=I,O[1]=pe,O}function S(I,E){let y=0,_;do[_,l,u]=E(n,g,s,l,u,t,r,o),E===oe?i+=1:i-=1,y+=1;while(_&&y<I);E===oe?p=[i-1,l,u]:h=[i,l,u]}}function At(n,e,t,s){return t[n[s]+e]}function oe(n,e,t,s,r,o,i,l){if(s===null){s=-1;do s+=1;while(s<n.length&&H(n[s],l)===0);return s>=n.length?xe:[n[s],s,null]}else{if(s>=n.length)return xe;{let u=n[s],{[Qe]:a,[Ze]:c,[Pt]:p}=u,f=H(u,l);if(c===e&&a&&f!==0&&(r===null||r<f-1)){r=r===null?0:r+1;let h=At(u,r,o,i);return[ue(p,t[h]),s,r===null?0:r]}else if(a){do s+=1;while(s<n.length&&H(n[s],l)===0);return s>=n.length?xe:[n[s],s,null]}else{do s+=1;while(s<n.length&&(n[s][Ze]>c||H(n[s],l)===0));return s>=n.length?xe:[n[s],s,null]}}}}function Lt(n,e,t,s,r,o,i,l){let u=n[s],{[Ze]:a,[Pt]:c,[Qe]:p}=u;if(s!==null&&a===e&&typeof r=="number"){if(r===0)return[u,s,null];{r-=1;let f=At(u,r,o,i);return[ue(c,t[f]),s,r]}}else{if(s===null)s=n.length-1;else{if(s===0)return xe;s-=1}let f=n[s];if({[Ze]:a,[Pt]:c,[Qe]:p}=f,a===e&&p){r=H(f,l)-1;let h=At(f,r,o,i);return[ue(c,t[h]),s,r]}for(;f[Qs]!==null&&n[f[Qs]][Qe]===!1;)s=f[b.PARENT_IDX],f=n[s];return[f,s,null]}}var $r=[],Me=class extends Ce{constructor(e,t,s,r,o=null,i=e.currentFilter){super(e.table,e.baseOffset,e.range);this.columns=t,this.groupby=s,this.groupState=r,this.aggregations=[],this.currentLength=0,this.groupRows=[],this.aggregatedColumn={},this.collapseChildGroups=this.collapseChildGroups.bind(this),this.countChildGroups=this.countChildGroups.bind(this),t.forEach(c=>{if(c.aggregate){let p=e.table.columnMap[c.name];this.aggregations.push([p,c.aggregate]),this.aggregatedColumn[p]=c.aggregate}}),this.expandedByDefault=!1,this.sortCriteria=Array.isArray(o)&&o.length?o:null,this.sortSet=e.data.map((c,p)=>p),this.rowParents=Array(e.data.length),this.applyGroupby(s);let[l,u,a]=this.selectNavigationSet(!1);this.iter=Ut(this.groupRows,this.groupBy,l,this.data,u,a),i&&this.filter(i)}get length(){return this.currentLength}get first(){return this.data[0]}get last(){return this.data[this.data.length-1]}currentRange(){return this.setRange(this.range,!1)}clearRange(){this.iter.clear(),this.range=Y}setSubscribedColumns(e){console.log(`GroupRowset setSubscribedColumns ${e.join(",")}`)}setRange(e,t=!0){t===!1&&e.lo===0&&this.clearRange();let[s,r]=!t&&e.lo===this.range.lo&&e.hi===this.range.hi?this.iter.currentRange():this.iter.setRange(e,t),o=this.filterSet&&b.FILTER_COUNT,i=s.map((l,u)=>this.cloneRow(l,r+u,o));return this.range=e,{dataType:this.type,rows:i,range:e,size:this.currentLength,offset:this.offset,stats:void 0}}cloneRow(e,t,s){let{IDX:r,DEPTH:o,COUNT:i}=b,l=e.slice();return l[r]=t+this.offset,s&&l[o]!==0&&typeof l[s]=="number"&&(l[i]=l[s]),l}applyGroupby(e,t=this.data){let{columns:s}=this;this.groupRows.length=0;let r=N(e,this.table.columnMap);this.groupRows=be(t,this.sortSet,s,this.table.columnMap,r,{groups:this.groupRows,rowParents:this.rowParents}),this.currentLength=this.countVisibleRows(this.groupRows,this.groupBy)}groupBy(e){Ds(e,this.groupby)?this.sortGroupby(e):Ke(e,this.groupby)?(this.extendGroupby(e),this.currentLength=this.countVisibleRows(this.groupRows,this.groupBy,this.filterSet!==null)):Fs(e,this.groupby)?(this.reduceGroupby(e),this.range=Y,this.iter.clear(),this.currentLength=this.countVisibleRows(this.groupRows,this.groupBy,this.filterSet!==null)):this.applyGroupby(e),this.iter.setGroupCount(e.length),this.groupby=e}setGroupState(e){He(e,this.groupState).forEach(([s,,r])=>{let{groupRows:o}=this;if(s==="*")this.toggleAll(r),this.currentLength=this.countVisibleRows(o,this.groupBy,!1);else{let i=this.findGroupIdx(s);i!==-1?r?this.currentLength+=this.expandGroup(i,o):this.currentLength-=this.collapseGroup(i,o):console.warn("setGroupState could not find row to toggle")}}),this.groupState=e}expandGroup(e,t){return this.toggleGroup(e,t,this.countChildGroups)}collapseGroup(e,t){return this.toggleGroup(e,t,this.collapseChildGroups)}toggleGroup(e,t,s){let{COUNT:r,DEPTH:o,FILTER_COUNT:i,IS_EXPANDED:l}=b,u=0,a=t[e],c=a[o],p=a[l],f=this.groupby.length,h=this.filterSet!==null;return a[l]=!p,c===f?u=a[h?i:r]:u=s(c+1,e+1,t,h),u}countChildGroups(e,t,s,r){let{DEPTH:o,FILTER_COUNT:i}=b,l=0;for(let u=t;u<s.length;u++){let a=s[u][o];if(a===e)(!r||s[u][i]>0)&&(l+=1);else if(a<e)break}return l}collapseChildGroups(e,t,s,r){let{DEPTH:o,FILTER_COUNT:i,IS_EXPANDED:l}=b,u=0;for(let a=t;a<s.length;a++){let{[o]:c,[l]:p}=s[a];if(c===e)(!r||s[a][i]>0)&&(u+=1,p&&(u+=this.collapseGroup(a,s)));else if(c<e)break}return u}sort(e){let{groupRows:t}=this,{IDX:s,DEPTH:r,COUNT:o,IDX_POINTER:i}=b;this.sortCriteria=Array.isArray(e)&&e.length?e:null;let l=N(e,this.table.columnMap);for(let u=0;u<t.length;u++){let a=t[u],c=a[r],p=a[o],f=Math.abs(c),h=a[i];f===1&&this.sortDataSubset(h,p,l,s)}}sortDataSubset(e,t,s,r){let o=[];for(let i=e;i<e+t;i++){let l=this.sortSet[i];o.push(this.data[l])}o.sort($(s));for(let i=0;i<o.length;i++)this.sortSet[i+e]=o[i][r]}clearFilter(){this.currentFilter=null,this.filterSet=null;let{data:e,groupRows:t,sortSet:s,columns:r}=this,{COUNT:o,FILTER_COUNT:i,NEXT_FILTER_IDX:l}=b,u=this.groupby.length,a=Mt(r,this.table.columnMap,this.groupby);for(let c=0;c<t.length;c++){let p=t[c];typeof p[i]=="number"&&p[o]>p[i]&&(Hs(t,c,s,e,r,a,u),p[i]=null,p[l]=null)}this.iter.setNavSet(this.selectNavigationSet(!1)),this.currentLength=this.countVisibleRows(t,!1)}filter(e){let t=Xe(this.currentFilter,e),s=e&&B(this.table.columnMap,e),{COUNT:r,DEPTH:o,PARENT_IDX:i,FILTER_COUNT:l,NEXT_FILTER_IDX:u}=b,{data:a,groupRows:c}=this,[p,f,h]=this.selectNavigationSet(t&&this.filterSet),g=[];for(let m=0;m<c.length;m++){let d=c[m],w=d[o],R=H(d,h,r);if(Math.abs(w)===1){let C=d[f],x=0;for(let I=C;I<C+R;I++){let E=p[I],y=a[E];s(y)&&(x+=1,x===1&&(d[u]=g.length),g.push(E))}d[l]=x;let S=$r;if(this.aggregations.length){S=this.aggregations.map(([E,y])=>[E,y,0]);let I=g.length;for(let E=I-x;E<I;E++){let y=g[E],_=a[y];for(let V=0;V<S.length;V++){let[U]=S[V];S[V][2]+=_[U]}}S.forEach(E=>{let[y,_,V]=E,U=y+b.count-2;_==="sum"?d[U]=V:_==="avg"&&(d[U]=V/x)})}if(x>0){let I=d;for(;I[i]!==null;)d=c[I[i]],S.forEach(E=>{let[y,_,V]=E,U=y+b.count-2;if(_==="sum")I[U]+=V;else if(_==="avg"){let O=I[l],K=O*I[U];I[U]=(K+V)/(O+x)}}),I[l]+=x}}else d[l]=0,this.aggregations.forEach(C=>{let[x]=C,S=x+b.count-2;d[S]=0})}this.filterSet=g,this.currentFilter=e,this.currentLength=this.countVisibleRows(this.groupRows,!0),this.iter.setNavSet(this.selectNavigationSet(!0))}update(e,t){let{groupRows:s,offset:r,rowParents:o,range:{lo:i}}=this,{COUNT:l,FILTER_COUNT:u,PARENT_IDX:a}=b,c,p=[];for(let g=0;g<t.length;g+=3){let m=t[g],d=m+b.count-2,w=t[g+1],R=t[g+2];p.push(d,w,R);let M=o[e],C=0;if(this.aggregatedColumn[m]){c=c||[];do{let x=s[M],S=x[d],I=R-w,E=this.aggregatedColumn[m];if(E==="sum")x[d]+=I;else if(E==="avg"){let y=H(x,u,l);x[d]=(x[d]*y+I)/y}(c[C]||(c[C]=[M])).push(d,S,x[d]),M=x[a],C+=1}while(M!==null)}}let f=[];if(c)for(let g=c.length-1;g>=0;g--){let[m,...d]=c[g],w=this.iter.getRangeIndexOfGroup(m);w!==-1&&f.push([i+w+r,...d])}let h=this.iter.getRangeIndexOfRow(e);return h!==-1&&f.push([i+h+r,...p]),f}insert(e,t){let{groupRows:s,groupby:r,data:o,sortSet:i,columns:l,iter:u}=this,a=N(r,this.table.columnMap,b.count-2),c=js(s,a,ue(t)),{IDX:p,COUNT:f,KEY:h,IDX_POINTER:g}=b,m=[[h,"asc"]],d=c.length===r.length,w=c.length===0,R=!w&&!d,M,C=null;if(d){let S=c[c.length-1],I=s[S];this.rowParents[e]=S;let E=I[f],y=I[g]+E;Ws(s,y),i.splice(y,0,t[p]),Gs(s,I)&&(this.currentLength+=1)}else{let S=N(r,this.table.columnMap);C=ne(s,$(m),qs(S,t,b),"last-available"),i.push(e);let I,E,y;R&&(E=S.slice(0,c.length),y=s[c[c.length-1]][p],S=S.slice(c.length)),I=be(o,i,l,this.table.columnMap,S,{startIdx:i.length-1,length:1,groupIdx:C-1,baseGroupby:E,rootIdx:y}),Bs(s,C,I.length),s.splice.apply(s,[C,0].concat(I))}return this.updateAggregatedValues(c,t),this.incrementGroupCounts(c),u.refresh(),(d?u.getRangeIndexOfRow(e):u.getRangeIndexOfGroup(C))!==-1?(M={replace:!0},C!==null&&(this.currentLength+=1)):w===!1&&(M={updates:this.collectGroupUpdates(c)}),M}incrementGroupCounts(e){let{groupRows:t}=this,{COUNT:s}=b;e.forEach(r=>{let o=t[r];o[s]+=1})}updateAggregatedValues(e,t){let{groupRows:s}=this;e.forEach(r=>{let o=s[r];for(let[i,l]of this.aggregations){let u=t[i],a=i+b.count-2,c=o[a];if(l==="sum")o[a]=c+u;else if(l==="avg"){let p=o[b.COUNT],f=p*o[a];o[a]=(f+u)/(p+1)}}})}collectGroupUpdates(e){let{aggregations:t,groupRows:s,offset:r}=this,{COUNT:o}=b,i=[];for(let l of e){let u=this.iter.getRangeIndexOfGroup(l);if(u!==-1){let a=s[l],c=[u+r,o,a[o]];for(let[p]of t){let f=p+b.count-2;c.push(f,a[f])}i.push(c)}}return i}findGroupIdx(e){let{groupRows:t}=this;for(let s=0;s<t.length;s++)if(t[s][b.KEY]===e)return s;return-1}toggleAll(e){let t=e?1:-1,{DEPTH:s}=b,{groupRows:r}=this;this.expandedByDefault=e;for(let o=0,i=r.length;o<i;o++){let l=r[o][s];r[o][s]=Math.abs(l)*t}}sortGroupby(e){let{IDX:t,KEY:s,DEPTH:r,IDX_POINTER:o,PARENT_IDX:i}=b,{groupRows:l}=this,u=N(e,this.table.columnMap,b.count-2),[a,c]=xt(e,this.groupby),p=0,f=0;for(;f<l.length;f++)Math.abs(l[f][r])>c?p>0&&(this.sortGroupRowsSubset(u,a,f-p,p),p=0):p+=1;this.sortGroupRowsSubset(u,a,f-p,p);let h=new Ct(e.length);this.groupRows.forEach((g,m)=>{let d=g[r],w=g[s],R=Math.abs(d);h.set(R,m,w),g[t]=m,R>1&&(g[o]=m+1),h.hasParentPos(R)&&(g[i]=h.parentPos(R))})}sortGroupRowsSubset(e,t,s=0,r=this.groupRows.length){let{groupRows:o}=this,i=s+r,[l,u]=e[t],a=(f,h)=>u===te?h>f:f>h,c=(f,h)=>u===te?h<f:f<h,p=null;for(let f=s;f<s+r;f++){let h=o[f][l];if(p===null)p=h;else if(a(h,p)){let g=o.splice(s,f-s);i-=g.length,o.splice.apply(o,[i,0].concat(g)),p=h,f=s-1}else if(c(h,p))break}}extendGroupby(e){let t=N(e,this.table.columnMap),s=t.slice(0,this.groupby.length),r=t.slice(this.groupby.length),{groupRows:o,groupby:i,data:l,columns:u,sortSet:a,filterSet:c}=this,{IDX_POINTER:p,PARENT_IDX:f,NEXT_FILTER_IDX:h}=b,g=i.length,m=new qe(g-1),d=this.currentFilter?B(this.table.columnMap,this.currentFilter):null;for(let w=0;w<o.length;w++){let R=o[w];m.idxAdjustment&&(R[b.IDX]+=m.idxAdjustment);let M=R[b.IDX],C=R[b.DEPTH],x=R[b.COUNT],S=R[b.KEY],I=R[b.FILTER_COUNT],E=R[h];if(R[b.NEXT_FILTER_IDX]=void 0,m.hasPrevious(C+1)&&(R[f]+=m.previous(C+1)),C===g){let y=R[p],_=be(l,a,u,this.table.columnMap,r,{depth:C+1,startIdx:y,length:x,rootIdx:M,baseGroupby:s,groupIdx:M,filterIdx:E,filterLength:I,filterSet:c,filterFn:d,rowParents:this.rowParents}),V=_.length;o.splice(w+1,0,..._),w+=V,m.increment(V)}else m.set(C,S);R[p]=M+1}}reduceGroupby(e){let{groupRows:t,filterSet:s}=this,[r]=ks(e,this.groupby),o=N(this.groupby,this.table.columnMap),[i,l,u]=Ks(o,r),{IDX:a,DEPTH:c,KEY:p,IDX_POINTER:f,PARENT_IDX:h,NEXT_FILTER_IDX:g}=b,m=e.length,d=new qe(m),w=s!==null,R=null,M=0;for(let C=t.length;M<C;M++){let x=t[M],S=x[c],I=x[p];if(S===r)this.reParentLeafRows(M,R),t.splice(M,1),M-=1,C-=1,d.increment(1);else{if(S<r){if(d.set(S,I),S===r-1){if(i)x[f]=St(t,f,c,M+1,S+1),x[g]=w?St(t,g,c,M+1,S+1):void 0;else if(R!==null){let E=this.regroupChildGroups(R,M,l,u);M-=E,C-=E,d.increment(E)}}R=M,d.hasPrevious(S-1)&&(x[h]-=d.previous(S-1))}d.idxAdjustment>0&&(x[a]-=d.idxAdjustment,x[c]<m&&(x[f]-=d.idxAdjustment))}}i||this.regroupChildGroups(R,M,l,u)}reParentLeafRows(e,t){let{groupRows:s,rowParents:r,sortSet:o}=this,{IDX_POINTER:i,COUNT:l}=b,u=s[e],a=u[i],c=u[l];for(let p=a;p<a+c;p++){let f=o[p];r[f]=t}}regroupChildGroups(e,t,s,r){let{groupRows:o,data:i,columns:l}=this,{COUNT:u,IDX_POINTER:a}=b,c=o[e],p=c[u],f=o[e+1][a],h=be(i,this.sortSet,l,this.table.columnMap,r,{startIdx:f,length:p,rootIdx:e,baseGroupby:s,groupIdx:e,rowParents:this.rowParents}),g=t-e-1;return o.splice(e+1,g,...h),c[a]=e+1,g-h.length}countVisibleRows(e,t,s=!1){let{IS_EXPANDED:r,DEPTH:o,COUNT:i,FILTER_COUNT:l}=b,u=0;for(let a=0,c=e.length;a<c;a++){let p=s&&e[a][l]===0;p||(u+=1);let{[r]:f,[o]:h}=e[a];if(!f||p)for(;a<c-1&&Math.abs(e[a+1][o])>h;)a+=1;else h===t&&(u+=s?e[a][l]:e[a][i])}return u}};var et=class{constructor(){this._queue=[]}get length(){return this._queue.length}update(e){let t=this.getCurrentBatch("update"),[s]=e,{updates:r}=t;for(let o=0,i=r.length;o<i;o++)if(r[o][0]===s){let l=r[o];for(let u=1;u<e.length;u+=2){let a=l.indexOf(e[u]);a===-1?l.push(e[u],e[u+1]):l[a+1]=e[u+1]}return}r.push(e)}resize(e){let t=this.getCurrentBatch("size");t.size=e}append(e,t){let s=this.getCurrentBatch("insert");s.rows.push(e),s.offset=t}replace({rows:e,filter:t,size:s,range:r,offset:o}){let i=this.getCurrentBatch("rowset");i.rows=e,i.size=s,i.range=r,i.offset=o,i.filter=t}popAll(){let e=this._queue;return this._queue=[],e}getCurrentBatch(e){let t=this._queue,s=t.length,r=s===0||e==="rowset"?t[0]=Zs(e):t[s-1];return r.type!==e&&(e==="insert"&&r.type==="size"?(r.type="insert",r.rows=[]):e==="size"&&r.type==="insert"||(r=t[s]=Zs(e))),r}};function Zs(n){switch(n){case"rowset":return{type:n,rows:[]};case"update":return{type:n,updates:[]};case"insert":return{type:n,rows:[]};case"size":return{type:n};default:throw Error("Unknown batch type")}}var Yr=0,en=!0;function Jr(n){return n.filter||Zr(n)}function Qr({type:n=null}){if(n===null)return"set";if(typeof n=="string")return n;switch(n.name){case"price":return"number";default:return n.name}}var Zr=n=>{switch(Qr(n)){case"number":return"number";default:return"set"}},tt=class{constructor(e,{columns:t=[],sortCriteria:s=null,groupBy:r=null,filter:o=null},i=new et){this._table=e,this._index_offset=Yr,this._filter=o,this._groupState=null,this._sortCriteria=s,this.columns=t,this._groupby=r,this._update_queue=i,this.reset=this.reset.bind(this),this.rowUpdated=this.rowUpdated.bind(this),this.rowsUpdated=this.rowsUpdated.bind(this),this.rowInserted=this.rowInserted.bind(this),this.reset(),e.on("ready",this.reset),e.on("rowUpdated",this.rowUpdated),e.on("rowsUpdated",this.rowsUpdated),e.on("rowInserted",this.rowInserted)}destroy(){this._table.removeListener("rowUpdated",this.rowUpdated),this._table.removeListener("rowInserted",this.rowInserted),this._table=null,this.rowSet=null,this.filterRowSet=null,this._update_queue=null}get status(){return this._table.status}get hasGroupBy(){return this._groupby?.length}reset(){let{_table:e,_groupby:t,rowSet:s}=this,r=s?s.range:null;if(this.rowSet=new j(e,this.columns,this._index_offset),this.filterRowSet=null,t!==null?this.rowSet=new Me(this.rowSet,this.columns,this._groupby,this._groupState):this._sortCriteria!==null&&this.rowSet.sort(this._sortCriteria),r){let o=this.setRange(r,!1);console.log(o),this._update_queue.replace(o)}}rowInserted(e,t,s){let{_update_queue:r,rowSet:o}=this,{size:i=null,replace:l,updates:u}=o.insert(t,s);if(i!==null&&r.resize(i),l){let{rows:a,size:c,offset:p}=o.currentRange();r.replace({rows:a,size:c,offset:p,filter:void 0,range:void 0})}else u&&u.forEach(a=>{r.update(a)})}rowUpdated(e,t,s){let{rowSet:r,_update_queue:o}=this,i=r.update(t,s);i&&(r instanceof j?o.update(i):i.forEach(l=>{o.update(l)}))}rowsUpdated(e,t,s){let{rowSet:r,_update_queue:o}=this,i=[];for(let l=0;l<t.length;l++){let[u,...a]=t[l],c=r.update(u,a);c&&(r instanceof j?i.push(c):c.forEach(p=>{i.push(p)}))}i.length>0&&s!==!0&&o.update(i)}getData(e){return e===A.ROW_DATA?this.rowSet:e===A.FILTER_DATA?this.filterRowSet:null}setSubscribedColumns(e){this.rowSet.setSubscribedColumns(e)}setRange(e,t=!0,s=A.ROW_DATA){return this.getData(s).setRange(e,t)}select(e,t=A.ROW_DATA){return this.getData(t).select(e)}selectAll(e=A.ROW_DATA){let t=this.getData(e);return this.selectResponse(t.selectAll(),e,t,!0)}selectNone(e=A.ROW_DATA){let t=this.getData(e);return this.selectResponse(t.selectNone(),e,t,!1)}selectResponse(e,t,s,r){let o=e.length>0,{stats:i}=s;if(t===A.ROW_DATA){if(o)return{updates:e}}else{let{totalSelected:l}=i;return l===0?this.applyFilterSetChangeToFilter({colName:s.columnName,type:z,values:[]}):r&&this.applyFilterSetChangeToFilter({colName:s.columnName,type:z,values:s.values}),{dataType:t,updates:e,stats:s.stats}}}sort(e){return this._sortCriteria=e,this.rowSet.sort(e),this.setRange(ke(this.rowSet.range),!1)}filter(e,t="rowData",s=!1,r=!1){if(t===A.FILTER_DATA)return[void 0,this.filterFilterData(e)];{s&&(e=is(this._filter,e));let{rowSet:o,_filter:i,filterRowSet:l}=this,{range:u}=o;this._filter=e;let a;if(e===null&&i)o.clearFilter();else if(e)this.rowSet.filter(e);else throw Error("InMemoryView.filter setting null filter when we had no filter anyway");if(l&&t===A.ROW_DATA&&!r)if(e)l.type===A.FILTER_DATA?a=l.setSelectedFromFilter(e):l.type===A.FILTER_BINS&&(this.filterRowSet=o.getBinnedValuesForColumn({name:this.filterRowSet.columnName}),a=this.filterRowSet.setRange());else{let{columnName:p,range:f}=l;this.filterRowSet=o.getDistinctValuesForColumn({name:p}),a=this.filterRowSet.setRange(f,!1)}let c={...this.rowSet.setRange(ke(u),!1),filter:e};return a?[c,a]:[c]}}filterFilterData(e){let{filterRowSet:t}=this;if(t)return e===null?t.clearFilter():e&&t.filter(e),t.setRange(ke(t.range),!1,en);console.error("[InMemoryView] filterfilterRowSet no filterRowSet")}applyFilterSetChangeToFilter(e){let[t]=this.filter(e,A.ROW_DATA,!0,!0);this._update_queue.replace(t)}applyFilter(){}groupBy(e){let{rowSet:t,columns:s,_groupState:r,_sortCriteria:o,_groupby:i}=this;return this._groupby=e,e.length===0?this.rowSet=j.fromGroupRowSet(this.rowSet):i===null?this.rowSet=new Me(t,s,e,r,o):t.groupBy(e),this.rowSet.currentRange()}toggleGroupState(e){let t={...this._groupState};return t[e]?delete t[e]:t[e]=!0,t}openTreeNode(e){let t=this.toggleGroupState(e);return this.setGroupState(t)}closeTreeNode(e){let t=this.toggleGroupState(e);return this.setGroupState(t)}setGroupState(e){this._groupState=e;let{rowSet:t}=this;return t.setGroupState(e),t.setRange(t.range,!1)}get updates(){let{_update_queue:e,rowSet:{range:t}}=this;return{updates:e.popAll(),range:{lo:t.lo,hi:t.hi}}}getFilterData(e,t){let{rowSet:s,filterRowSet:r,_filter:o}=this,i=e.name,l=this.columns.find(a=>a.name===i);return Jr(l)==="number"?this.filterRowSet=s.getBinnedValuesForColumn(e):!r||r.columnName!==e.name?this.filterRowSet=s.getDistinctValuesForColumn(e):r&&r.columnName===e.name&&r.setRange({lo:0,hi:0}),o?this.filterRowSet.setSelectedFromFilter(o):this.filterRowSet.selectAll(),this.filterRowSet.setRange(t,!1,en)}};var st=class extends ee{constructor({valueColumns:e,...t}){super(t);this.valueColumns=e}setData(e){let{index:t}=this;for(let s=0;s<e.length;s++){let[r,o]=e[s];t[o]=r}this.rows=e}async loadData(e){console.log(`import data from ${e}.js`);try{let{default:t}=await import(`${e}`);t&&this.setData(t)}catch(t){console.error(`failed to load data from path '${e}'`,t)}}};var nt=[],tn={filter:""},sn={sortDefs:[]},nn=({columns:n=nt,filterSpec:e=tn,groupBy:t=nt,sort:s=sn},{columns:r=nt,filterSpec:o=tn,groupBy:i=nt,sort:l=sn})=>{let u={};return rn(n,r)||(u.columns=!0),eo(s,l)||(u.sort=!0),rn(t,i)||(u.groupBy=!0),e.filter!==o.filter&&(u.filter=!0),u};function rn(n,e){return!(n.length!==e.length||n.some(({column:t,sortType:s})=>!e.find(r=>r.column===t&&r.sortType===s)))}function eo({sortDefs:n},{sortDefs:e}){return!(n.length!==e.length||n.some(({col:t,dir:s},r)=>{let{col:o,dir:i}=e[r];return o===t&&i===s}))}var on=_e("DataStoreConnection",fe.brown),ln={and:L,or:ie,"=":Pe,">":Oe,"<":Ue,in:z},un=n=>{let{column:e,op:t,value:s,values:r,filters:o}=n;return o?{type:ln[t],filters:o.map(un)}:{type:ln[t],colName:e,value:s,values:r}};async function Nt(n,e){return to(n,t=>{e(t)})}async function to(n,e,t){e({type:"connection-status",status:"connecting"});let s=await so(n);t=new an(s,n,e);let r="connected";return e({type:"connection-status",status:r}),t.status=r,t}var so=async n=>{console.log(`table config url ${n}`);let e=async()=>await import(n),{config:t}=await e();console.log(`got config ${JSON.stringify(t,null,2)}`);let{generateData:s}=await import(t.dataUrl),r=new st(t);return r.setData(s()),new tt(r,{columns:t.columns})},an=class{constructor(e,t,s){this.url=t,this.connectionCallback=s,this.viewPortId=void 0,this.setDataStore(e),this.status="ready",this.viewportMeta=null}setDataStore(e){let{connectionCallback:t}=this,s=(o,i)=>{let{requestId:l,body:u}=o;switch(u.type){case"CREATE_VP":{let a=this.viewPortId=l,{columns:c,filterSpec:p,groupBy:f,sort:h,range:g,table:m}=u;t({requestId:l,body:{type:"CREATE_VP_SUCCESS",viewPortId:a,columns:c,range:g,table:m}});let{rows:d,size:w}=e.setRange({lo:g.from,hi:g.to},!0),R=+new Date;t({requestId:"NA",body:{type:"TABLE_ROW",timeStamp:R,rows:[{viewPortId:a,vpSize:w,rowIndex:-1,rowKey:"SIZE",updateType:"SIZE",sel:0,ts:R,data:[]}].concat(d.map(([M,,,,,,C,x,...S])=>({viewPortId:a,vpSize:w,rowIndex:M,rowKey:C,updateType:"U",sel:x,ts:R,data:S})))}}),this.viewportMeta={columns:c,filterSpec:p,groupBy:f,sort:h}}break;case"CHANGE_VP_RANGE":{let{from:a,to:c,viewPortId:p}=u;t({requestId:l,body:{type:"CHANGE_VP_RANGE_SUCCESS",viewPortId:p,from:a,to:c}});let{rows:f,size:h}=e.setRange({lo:a,hi:c},!0);e.hasGroupBy?t(ae(p,f,h)):t(Ve(p,f,h))}break;case"CHANGE_VP":{let{type:a,viewPortId:c,...p}=u,f=nn(this.viewportMeta,p);if(this.viewportMeta=p,t({requestId:l,body:{type:"CHANGE_VP_SUCCESS",viewPortId:c}}),f.filter){let h=un(i.filter),[{rows:g,size:m}]=e.filter(h);e.hasGroupBy?t(ae(c,g,m)):t(Ve(c,g,m))}else if(f.sort){let h=u.sort.sortDefs.map(({column:d,sortType:w})=>[d,w==="D"?"dsc":"asc"]),{rows:g,size:m}=e.sort(h);e.hasGroupBy?t(ae(c,g,m)):t(Ve(c,g,m))}else if(f.groupBy){let{rows:h,size:g}=e.groupBy(u.groupBy);u.groupBy.length>0?t(ae(c,h,g)):t(Ve(c,h,g))}}break;case"SET_SELECTION":{let{viewPortId:a}=this,{rows:c}=e.select(u.selection);t(Ve(a,c))}break;case"OPEN_TREE_NODE":{let{viewPortId:a}=this,{rows:c,size:p}=e.openTreeNode(u.treeKey);t(ae(a,c,p))}break;case"CLOSE_TREE_NODE":{let{viewPortId:a}=this,{rows:c,size:p}=e.closeTreeNode(u.treeKey);t(ae(a,c,p))}break;default:on.log(`Unknown message type from client ${u.type}`)}};this.send=s;let r=o=>{on.log(`Message cannot be sent, socket closed: ${o.type}`)};this.close=()=>{console.log("[Connection] close dataStoreConnection"),this.status="closed",this.send=r}}};function Ve(n,e,t){let s=+new Date;return{requestId:"NA",body:{type:"TABLE_ROW",timeStamp:s,rows:e.map(([r,,,,,,o,i,...l])=>({viewPortId:n,vpSize:t,rowIndex:r,rowKey:o,updateType:"U",sel:i,ts:s,data:l}))}}}function ae(n,e,t){let s=+new Date;return{requestId:"NA",body:{type:"TABLE_ROW",timeStamp:s,rows:[{viewPortId:n,vpSize:t,rowIndex:-1,rowKey:"SIZE",updateType:"SIZE",sel:0,ts:s,data:[]}].concat(e.map(([r,,o,i,l,u,a,c,...p])=>({viewPortId:n,vpSize:t,rowIndex:r,rowKey:a,updateType:"U",sel:c,ts:s,data:[Math.abs(l),i,a,o,"",u,...p]})))}}}var cn="CHANGE_VP",pn="CHANGE_VP_SUCCESS",Ft="CHANGE_VP_RANGE",fn="CHANGE_VP_RANGE_SUCCESS",hn="CLOSE_TREE_NODE",gn="CLOSE_TREE_SUCCESS";var Dt="CREATE_VISUAL_LINK",dn="CREATE_VISUAL_LINK_SUCCESS",mn="CREATE_VP",wn="CREATE_VP_SUCCESS",Rn="DISABLE_VP",yn="DISABLE_VP_SUCCESS";var In="ENABLE_VP",bn="ENABLE_VP_SUCCESS";var En="GET_TABLE_LIST",Sn="GET_TABLE_META",Cn="GET_VP_VISUAL_LINKS",xn="GET_VIEW_PORT_MENUS",Mn="VIEW_PORT_MENUS_RESP";var kt="VIEW_PORT_MENU_RESP";var Vn="HB",_n="HB_RESP",Tn="LOGIN",vn="LOGIN_SUCCESS",Pn="OPEN_TREE_NODE",On="OPEN_TREE_SUCCESS";var Un="REMOVE_VP",An="REMOVE_VP_SUCCESS";var Ln="RPC_CALL",Gt="RPC_RESP";var Nn="SET_SELECTION",Fn="SET_SELECTION_SUCCESS",Bt="TABLE_META_RESP",Wt="TABLE_LIST_RESP",Dn="VP_VISUAL_LINKS_RESP",kn="TABLE_ROW";var no=n=>typeof n.from=="number"&&typeof n.to=="number",ro=n=>typeof n.lo=="number"&&typeof n.hi=="number",jt=class{constructor(e){this.keys=new Map,this.free=[],this.nextKeyValue=0,no(e)?this.reset(e):ro(e)&&this.reset({from:e.lo,to:e.hi})}next(){return this.free.length>0?this.free.pop():this.nextKeyValue++}reset({from:e,to:t}){this.keys.forEach((r,o)=>{(o<e||o>=t)&&(this.free.push(r),this.keys.delete(o))});let s=t-e;this.keys.size+this.free.length>s&&(this.free.length=s-this.keys.size);for(let r=e;r<t;r++)if(!this.keys.has(r)){let o=this.next();this.keys.set(r,o)}}keyFor(e){let t=this.keys.get(e);if(t===void 0)throw Error(`KeySet, no key found for rowIndex ${e}`);return t}};var rt=(n,e,t,s)=>{let r=s*.25;return!n||!s||n.to-t<r?!0:n.from>0&&e-n.from<r};var ot=[],qt=class{constructor({lo:e,hi:t},{from:s,to:r},o){this.setRowCount=e=>{if(e<this.internalData.length&&(this.internalData.length=e),e<this.rowCount){this.rowsWithinRange=0;let t=Math.min(e,this.clientRange.to);for(let s=this.clientRange.from;s<t;s++){let r=s-this.range.from;this.internalData[r]!==void 0&&(this.rowsWithinRange+=1)}}this.rowCount=e};this.bufferSize=o,this.clientRange=new le(e,t),this.range=new le(s,r),this.internalData=new Array(o),this.rowsWithinRange=0,this.rowCount=0}get hasAllRowsWithinRange(){return this.rowsWithinRange===this.clientRange.to-this.clientRange.from||this.rowCount>0&&this.rowsWithinRange===this.rowCount}setAtIndex(e,t){let s=this.isWithinClientRange(e);if(s||this.isWithinRange(e)){let r=e-this.range.from;!this.internalData[r]&&s&&(this.rowsWithinRange+=1),this.internalData[r]=t}return s}getAtIndex(e){return this.range.isWithin(e)&&this.internalData[e-this.range.from]!=null?this.internalData[e-this.range.from]:void 0}isWithinRange(e){return this.range.isWithin(e)}isWithinClientRange(e){return this.clientRange.isWithin(e)}setClientRange(e,t){let s=this.clientRange.from,r=Math.min(this.clientRange.to,this.rowCount);if(e===s&&t===r)return[!1,ot,ot];let o=this.clientRange.copy();this.clientRange.from=e,this.clientRange.to=t,this.rowsWithinRange=0;for(let c=e;c<t;c++){let p=c-this.range.from;this.internalData[p]&&(this.rowsWithinRange+=1)}let i=ot,l=ot,u=this.range.from;if(this.hasAllRowsWithinRange)if(t>o.to){let c=Math.max(e,o.to);i=this.internalData.slice(c-u,t-u)}else{let c=Math.min(o.from,t);i=this.internalData.slice(e-u,c-u)}else if(this.rowsWithinRange>0)if(t>o.to){let c=Math.max(e,o.to);l=this.internalData.slice(c-u,t-u).filter(p=>!!p)}else{let c=Math.min(o.from,t);l=this.internalData.slice(Math.max(0,e-u),c-u).filter(p=>!!p)}return[rt(this.range,e,t,this.bufferSize),i,l]}setRange(e,t){let[s,r]=this.range.overlap(e,t),o=new Array(t-e+this.bufferSize);this.rowsWithinRange=0;for(let i=s;i<r;i++){let l=this.getAtIndex(i);if(l){let u=i-e;o[u]=l,this.isWithinClientRange(i)&&(this.rowsWithinRange+=1)}}this.internalData=o,this.range.from=e,this.range.to=t}getData(){let{from:e,to:t}=this.range,{from:s,to:r}=this.clientRange,o=Math.max(0,s-e),i=Math.min(t-e,t,r-e,this.rowCount??t);return this.internalData.slice(o,i)}};var oo=[],io=[],lo=([n],[e])=>n-e,Kt=class{constructor({viewport:e,tablename:t,aggregations:s,columns:r,range:o,bufferSize:i=0,filter:l="",filterQuery:u="",sort:a=[],groupBy:c=[],visualLink:p}){this.dataWindow=void 0;this.disabled=!1;this.hasUpdates=!1;this.holdingPen=[];this.lastTouchIdx=null;this.links=[];this.linkedParent=null;this.pendingOperations=new Map;this.pendingRangeRequest=null;this.rowCountChanged=!1;this.isTree=!1;this.status="";this.suspended=!1;this.getNewRowCount=()=>{if(this.rowCountChanged&&this.dataWindow)return this.rowCountChanged=!1,this.dataWindow.rowCount};this.clientViewportId=e,this.table=t,this.aggregations=s,this.columns=r,this.clientRange=o,this.bufferSize=i,this.sort={sortDefs:a},this.groupBy=c,this.filterSpec={filter:u},this.filter=l,this.keys=new jt(o),this.pendingLinkedParent=p}get hasUpdatesToProcess(){return this.suspended?!1:this.rowCountChanged||this.hasUpdates}subscribe(){return{type:mn,table:this.table,range:se(this.clientRange,this.bufferSize),aggregations:this.aggregations,columns:this.columns,sort:this.sort,groupBy:this.groupBy,filterSpec:this.filterSpec}}handleSubscribed({viewPortId:e,aggregations:t,columns:s,range:r,sort:o,groupBy:i,filterSpec:l}){return this.serverViewportId=e,this.status="subscribed",this.aggregations=t,this.columns=s,this.sort=o,this.groupBy=i,this.filterSpec=l,this.isTree=i&&i.length>0,this.dataWindow=new qt(this.clientRange,r,this.bufferSize),console.log(`%cViewport subscribed
        clientVpId: ${this.clientViewportId}
        serverVpId: ${this.serverViewportId}
        table: ${this.table}
        aggregations: ${JSON.stringify(t)}
        columns: ${s.join(",")}
        range: ${JSON.stringify(r)}
        sort: ${JSON.stringify(o)}
        groupBy: ${JSON.stringify(i)}
        filterSpec: ${JSON.stringify(l)}
        bufferSize: ${this.bufferSize}
      `,"color: blue"),{type:"subscribed",clientViewportId:this.clientViewportId,columns:s,filter:this.filter,filterSpec:this.filterSpec}}awaitOperation(e,t){this.pendingOperations.set(e,t)}completeOperation(e,...t){let{clientViewportId:s,pendingOperations:r}=this,{type:o,data:i}=r.get(e);if(r.delete(e),o===Ft){let[l,u]=t;this.dataWindow?.setRange(l,u),this.pendingRangeRequest=null}else{if(o==="groupBy")return this.isTree=!0,this.groupBy=i,{clientViewportId:s,type:o,groupBy:i};if(o==="groupByClear")return this.isTree=!1,this.groupBy=[],{clientViewportId:s,type:"groupBy",groupBy:null};if(o==="filter")return this.filterSpec={filter:i.filterQuery},{clientViewportId:s,type:o,...i};if(o==="aggregate")return this.aggregations=i,{clientViewportId:s,type:o,aggregations:i};if(o==="sort")return this.sort={sortDefs:i},{clientViewportId:s,type:o,sort:i};if(o!=="selection"){if(o==="disable")return this.disabled=!0,{type:"disabled",clientViewportId:s};if(o==="enable")return this.disabled=!1,{type:"enabled",clientViewportId:s};if(o===Dt){let[l,u,a]=t;return this.linkedParent={colName:l,parentViewportId:u,parentColName:a},this.pendingLinkedParent=null,{type:"visual-link-created",clientViewportId:s,colName:l,parentViewportId:u,parentColName:a}}}}}rangeRequest(e,t,s){let r=Ft;if(this.dataWindow){let[o,i,l]=this.dataWindow.setClientRange(t,s),u=o&&rt(this.pendingRangeRequest,t,s,this.bufferSize)?{type:r,viewPortId:this.serverViewportId,...se({from:t,to:s},this.bufferSize,this.dataWindow.rowCount)}:null;u&&(this.awaitOperation(e,{type:r}),this.pendingRangeRequest=u),this.keys.reset(this.dataWindow.clientRange);let a=([p])=>p<t||p>=s;this.holdingPen.some(a)&&(this.holdingPen=this.holdingPen.filter(([p])=>p>=t&&p<s));let c=this.isTree?Xt(this.groupBy,this.columns):Ht;return l.length&&l.forEach(p=>{this.holdingPen.push(c(p,this.keys))}),i.length?[u,i.map(p=>c(p,this.keys))]:[u]}else return[null]}setLinks(e){return this.links=e,[{type:"VP_VISUAL_LINKS_RESP",links:e,clientViewportId:this.clientViewportId},this.pendingLinkedParent]}setMenu(e){return{type:"VIEW_PORT_MENUS_RESP",menu:e,clientViewportId:this.clientViewportId}}createLink(e,t,s,r){let o={type:Dt,parentVpId:s,childVpId:this.serverViewportId,parentColumnName:r,childColumnName:t};return this.awaitOperation(e,o),o}suspend(){this.suspended=!0}resume(){return this.suspended=!1,this.currentData()}currentData(){let e=[];if(this.dataWindow){let t=this.dataWindow.getData(),{keys:s}=this,r=this.isTree?Xt(this.groupBy,this.columns):Ht;for(let o of t)o&&e.push(r(o,s))}return e}enable(e){return this.awaitOperation(e,{type:"enable"}),{type:In,viewPortId:this.serverViewportId}}disable(e){return this.awaitOperation(e,{type:"disable"}),{type:Rn,viewPortId:this.serverViewportId}}filterRequest(e,t,s){return this.awaitOperation(e,{type:"filter",data:{filter:t,filterQuery:s}}),this.createRequest({filterSpec:{filter:s}})}aggregateRequest(e,t){return this.awaitOperation(e,{type:"aggregate",data:t}),this.createRequest({aggregations:t})}sortRequest(e,t){return this.awaitOperation(e,{type:"sort",data:t}),this.createRequest({sort:{sortDefs:t}})}groupByRequest(e,t=io){let s=t===oo?"groupByClear":"groupBy";return this.awaitOperation(e,{type:s,data:t}),this.createRequest({groupBy:t})}selectRequest(e,t){return this.awaitOperation(e,{type:"selection",data:t}),{type:Nn,vpId:this.serverViewportId,selection:t}}handleUpdate(e,t,s){this.dataWindow&&(this.dataWindow.rowCount!==s.vpSize&&(this.dataWindow.setRowCount(s.vpSize),this.rowCountChanged=!0),e==="U"&&this.dataWindow.setAtIndex(t,s)&&(this.hasUpdates=!0))}getClientRows(e){if(this.hasUpdates&&this.dataWindow){let t=this.dataWindow.getData(),{keys:s}=this,r=this.isTree?Xt(this.groupBy,this.columns):Ht,o=this.dataWindow.hasAllRowsWithinRange?this.holdingPen.splice(0):void 0,i=o||this.holdingPen;for(let l of t)l&&l.ts>=e&&i.push(r(l,s));return this.hasUpdates=!1,o&&o.sort(lo)}}createRequest(e){return{type:cn,viewPortId:this.serverViewportId,aggregations:this.aggregations,columns:this.columns,sort:this.sort,groupBy:this.groupBy,filterSpec:this.filterSpec,...e}}},Ht=({rowIndex:n,rowKey:e,sel:t,data:s},r)=>[n,r.keyFor(n),!0,null,null,1,e,t].concat(s),Xt=(n,e)=>({rowIndex:t,rowKey:s,sel:r,data:o},i)=>{let[l,u,,a,,c,...p]=o,f=s.split("|").slice(1);return n.forEach((g,m)=>{let d=e.indexOf(g);p[d]=f[m]}),[t,i.keyFor(t),a,u,l,c,s,r].concat(p)};var Gn=n=>{switch(n){case"getUniqueFieldValues":return["TypeAheadRpcHandler","TYPEAHEAD"];default:return["OrderEntryRpcHandler","SIMUL"]}};var Bn=n=>n.type==="connection-status",Wn=n=>"viewport"in n;var jn=1;var G=()=>`${jn++}`,uo=[],ao={},co=(n,e)=>{if(n==="MENU_RPC_CALL"&&e==="selected-rows")return"VIEW_PORT_MENUS_SELECT_RPC";throw Error("No RPC command for ${msgType} / ${context}")},zt=class{constructor(e,t){this.queuedRequests=[];this.connection=e,this.postMessageToClient=t,this.viewports=new Map,this.mapClientToServerViewport=new Map}async login(e){console.log(`ServerProxy login ${e}`),e&&(this.authToken=e);let t=this.authToken;if(t===void 0)throw Error("ServerProxy login, cannot login until auth token has been obtained");return new Promise((s,r)=>{console.log("[ServerProxy login]"),this.sendMessageToServer({type:Tn,token:t,user:"user"},""),this.pendingLogin={resolve:s,reject:r}})}subscribe(e){if(this.mapClientToServerViewport.has(e.viewport))console.log(`ServerProxy spurious subscribe call ${e.viewport}`);else{let t=new Kt(e);this.viewports.set(e.viewport,t);let s=this.sessionId!=="";this.sendIfReady(t.subscribe(),e.viewport,s)}}unsubscribe(e){let t=this.mapClientToServerViewport.get(e);t?this.sendMessageToServer({type:Un,viewPortId:t}):console.error(`ServerProxy: failed to unsubscribe client viewport ${e}`)}getViewportForClient(e){let t=this.mapClientToServerViewport.get(e);if(t){let s=this.viewports.get(t);if(s)return s;throw Error(`Viewport not found for client viewport ${e}`)}else throw Error(`Viewport server id not found for client viewport ${e}`)}setViewRange(e,t){let s=G(),[r,o]=e.rangeRequest(s,t.range.lo,t.range.hi);r&&this.sendIfReady(r,s,e.status==="subscribed"),o&&this.postMessageToClient({type:"viewport-updates",viewports:{[e.clientViewportId]:{rows:o}}})}aggregate(e,t){let s=G(),r=e.aggregateRequest(s,t.aggregations);this.sendIfReady(r,s,e.status==="subscribed")}sort(e,t){let s=G(),r=e.sortRequest(s,t.sortCriteria);this.sendIfReady(r,s,e.status==="subscribed")}groupBy(e,t){let s=G(),r=e.groupByRequest(s,t.groupBy);this.sendIfReady(r,s,e.status==="subscribed")}filter(e,t){let s=G(),{filter:r,filterQuery:o}=t,i=e.filterRequest(s,r,o);this.sendIfReady(i,s,e.status==="subscribed")}select(e,t){let s=G(),{selected:r}=t,o=e.selectRequest(s,r);this.sendIfReady(o,s,e.status==="subscribed")}disableViewport(e,t){let s=G(),r=e.disable(s);this.sendIfReady(r,s,e.status==="subscribed")}enableViewport(e,t){let s=G(),r=e.enable(s);this.sendIfReady(r,s,e.status==="subscribed")}resumeViewport(e){let t=e.resume();this.postMessageToClient({type:"viewport-updates",viewports:{[e.clientViewportId]:{rows:t}}})}openTreeNode(e,t){e.serverViewportId&&this.sendIfReady({type:Pn,vpId:e.serverViewportId,treeKey:t.key},G(),e.status==="subscribed")}closeTreeNode(e,t){e.serverViewportId&&this.sendIfReady({type:hn,vpId:e.serverViewportId,treeKey:t.key},G(),e.status==="subscribed")}createLink(e,t){let{parentVpId:s,parentColumnName:r,childColumnName:o}=t,i=G(),l=e.createLink(i,o,s,r);this.sendMessageToServer(l,i)}menuRpcCall(e,t){if(e.serverViewportId){let{context:s,rpcName:r}=t;this.sendMessageToServer({type:co(t.type,s),rpcName:r,vpId:e.serverViewportId},t.requestId)}}rpcCall(e){let{method:t,requestId:s,type:r}=e,[o,i]=Gn(t);this.sendMessageToServer({type:r,service:o,method:t,params:e.params,namedParams:{}},s,{module:i})}handleMessageFromClient(e){if(Wn(e)){let t=this.getViewportForClient(e.viewport);switch(e.type){case"setViewRange":return this.setViewRange(t,e);case"aggregate":return this.aggregate(t,e);case"sort":return this.sort(t,e);case"groupBy":return this.groupBy(t,e);case"filterQuery":return this.filter(t,e);case"select":return this.select(t,e);case"suspend":return t.suspend();case"resume":return this.resumeViewport(t);case"disable":return this.disableViewport(t,e);case"enable":return this.enableViewport(t,e);case"openTreeNode":return this.openTreeNode(t,e);case"closeTreeNode":return this.closeTreeNode(t,e);case"createLink":return this.createLink(t,e);case"MENU_RPC_CALL":return this.menuRpcCall(t,e);default:}}else{let{type:t,requestId:s}=e;switch(t){case En:return this.sendMessageToServer({type:t},s);case Sn:return this.sendMessageToServer({type:t,table:e.table},s);case Ln:return this.rpcCall(e);default:}}console.log(`Vuu ServerProxy Unexpected message from client ${JSON.stringify(e)}`)}sendIfReady(e,t,s=!0,r){return s?this.sendMessageToServer(e,t,r):this.queuedRequests.push(e),s}sendMessageToServer(e,t=`${jn++}`,s=ao){let{module:r="CORE",...o}=s;this.authToken&&this.connection.send({requestId:t,sessionId:this.sessionId,token:this.authToken,user:"user",module:r,body:e})}handleMessageFromServer(e){let{body:t,requestId:s,sessionId:r}=e,{viewports:o}=this;switch(t.type){case Vn:this.sendMessageToServer({type:_n,ts:+new Date},"NA");break;case vn:this.sessionId=r,this.pendingLogin?.resolve(r);break;case wn:{let l=o.get(s);if(l){let{viewPortId:u}=t;s!==u&&(o.delete(s),o.set(u,l)),this.mapClientToServerViewport.set(s,u);let a=l.handleSubscribed(t);a&&this.postMessageToClient(a),this.sendMessageToServer({type:Cn,vpId:u}),this.sendMessageToServer({type:xn,vpId:u})}}break;case An:{let l=this.viewports.get(t.viewPortId);l&&(this.mapClientToServerViewport.delete(l.clientViewportId),o.delete(t.viewPortId))}break;case Fn:let i=this.viewports.get(t.vpId);i&&i.completeOperation(s);break;case pn:case yn:if(o.has(t.viewPortId)){let l=this.viewports.get(t.viewPortId);if(l){let u=l.completeOperation(s);u&&this.postMessageToClient(u)}}break;case bn:{let l=this.viewports.get(t.viewPortId);if(l){let u=l.completeOperation(s);if(u){this.postMessageToClient(u);let a=l.currentData(),c={type:"viewport-updates",viewports:{[l.clientViewportId]:{rows:a}}};this.postMessageToClient(c)}}}break;case kn:{let{timeStamp:l}=t,[{ts:u}={ts:l}]=t.rows||uo;for(let a of t.rows){let{viewPortId:c,rowIndex:p,rowKey:f,updateType:h}=a,g=o.get(c);g?g.isTree&&h==="U"&&!f.startsWith("$root")?console.log("Ignore blank rows sent after GroupBy"):g.handleUpdate(h,p,a):console.warn(`TABLE_ROW message received for non registered viewport ${c}`)}this.processUpdates(u)}break;case fn:{let l=this.viewports.get(t.viewPortId);if(l){let{from:u,to:a}=t;l.completeOperation(s,u,a)}}break;case On:case gn:break;case dn:{let l=this.viewports.get(t.childVpId),u=this.viewports.get(t.parentVpId);if(l&&u){let{childColumnName:a,parentColumnName:c}=t,p=l.completeOperation(s,a,u.clientViewportId,c);p&&this.postMessageToClient(p)}}break;case Wt:this.postMessageToClient({type:Wt,tables:t.tables,requestId:s});break;case Bt:this.postMessageToClient({type:Bt,table:t.table,columns:t.columns,dataTypes:t.dataTypes,requestId:s});break;case Dn:{let l=this.getActiveLinks(t.links),u=this.viewports.get(t.vpId);if(l.length&&u){let[a,c]=u.setLinks(l);if(this.postMessageToClient(a),c){let{colName:p,parentViewportId:f,parentColName:h}=c,g=G(),m=this.mapClientToServerViewport.get(f);if(m){let d=u.createLink(g,p,m,h);this.sendMessageToServer(d,g)}}}}break;case Mn:if(t.menu.name){let l=this.viewports.get(t.vpId);if(l){let u=l.setMenu(t.menu);this.postMessageToClient(u)}}break;case kt:{let{action:l}=t;this.postMessageToClient({type:kt,action:l,tableAlreadyOpen:this.isTableOpen(l.table),requestId:s})}break;case Gt:{let{method:l,result:u}=t;this.postMessageToClient({type:Gt,method:l,result:u,requestId:s})}break;case"ERROR":console.error(t.msg);break;default:console.log(`handleMessageFromServer ${t.type}.`)}}isTableOpen(e){if(e){let t=e.table;for(let s of this.viewports.values())if(!s.suspended&&s.table.table===t)return!0}}getActiveLinks(e){return e.filter(t=>{let s=this.viewports.get(t.parentVpId);return s&&!s.suspended})}processUpdates(e){let t;this.viewports.forEach(s=>{if(s.hasUpdatesToProcess){let r=s.getClientRows(e),o=s.getNewRowCount();(o!==void 0||r&&r.length>0)&&(t=t||{type:"viewport-updates",viewports:{}},t.viewports[s.clientViewportId]={rows:r,size:o})}t&&this.postMessageToClient(t)})}};var ce;async function po(n,e,t,s){let o=await(t?lt:Nt)(n,i=>Bn(i)?s(i):ce.handleMessageFromServer(i));ce=new zt(o,i=>ho(i)),o.requiresLogin&&await ce.login(e)}var $t=0,fo=[];function ho(n){let e=Math.round(performance.now());$t&&fo.push(e-$t),postMessage(n),$t=e}var go=async({data:n})=>{switch(n.type){case"connect":await po(n.url,n.token,n.useWebsocket,postMessage),postMessage({type:"connected"});break;case"subscribe":ce.subscribe(n);break;case"unsubscribe":ce.unsubscribe(n.viewport);break;default:ce.handleMessageFromClient(n)}};self.addEventListener("message",go);postMessage({type:"ready"});
//# sourceMappingURL=worker.js.map
