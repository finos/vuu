name: Legal report with Maven

on:
  push:
    paths:
      - '**/pom.xml'
      - '.github/workflows/legal-report.yml'

env:
  ALLOW_LICENSES: "licenses/license/name!='The Apache Software License, Version 2.0' and licenses/license/name!='BSD' and
   licenses/license/name!='BSD-style license' and licenses/license/name!='Apache License, Version 2.0' and 
   licenses/license/name!='Eclipse Public License - v 1.0' and licenses/license/name!='GNU General Public License'"
  REPORT_PATH: "target/generated-resources/licenses.xml"

jobs:

  legal-scanning:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        package-folder: [toolbox, vuu, vuu-java]

    steps:
    - uses: actions/checkout@v3

    - name: Set up JDK 1.17
      uses: actions/setup-java@v4
      with:
        java-version: 17
        java-package: jdk
        distribution: temurin
        cache: 'maven'

    - name: Install XQ
      run: pip install xq

    - name: Maven build
      run: mvn clean install -DskipTests

    - name: License XML report
      run: mvn org.codehaus.mojo:license-maven-plugin:2.0.0:download-licenses
      working-directory: ${{ matrix.package-folder }}

    - name: Validate XML report
      run: |
        LICENSES=`xq ".results.result[].dependency.licenses.licence[].name' <<< ${{ env.REPORT_PATH }}`
        echo "LICENSES: $LICENSES"
        LINES_FOUND=$(echo "$LICENSES" | wc -l)        
        if [ "$LINES_FOUND" -gt 1 ]; then 
          echo "License issues found! $LICENSE_REPORT"
          exit 1
        fi
      working-directory: ${{ matrix.package-folder }}

    - name: Upload license XML reports
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.package-folder }}-license-xml-report
        path: '**/target/generated-resources/licenses.xml'
